( Solo Forth library )                                          \ Copyright (C) 2015 Marcos Cruz (programandala.net)            \ This file is part of Solo Forth                               \ http://programandala.net/en.program.solo_forth.html           \ Last modified: 201509182220                                   \ See <AKNOWLEDGMENTS.adoc>.                                    \ You may do whatever you want with this work, so long as you   \ retain all copyright notices, all credit notices, and this    \ license in all redistributed copies and derived works. There  \ is no warranty.                                                                                                                                                                                                                                                                                                                                                                                                                                               ( ) \ scr 1 -- testing load screen                              variable default-first-locatable                                8 default-first-locatable                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( need ) \ scr 2                                                : reload  ( -- )  scr @ load  ;                                 : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;       variable default-first-locatable                                variable first-locatable                                          8 dup default-first-locatable !  first-locatable !            variable last-locatable  scr/disk last-locatable ! -->          : located  ( ca len -- screen | false ) [ 2 border ]              [ 4 border ]  \ XXX INFORMER                                    default-first-locatable @  first-locatable !                    do                                                                0 i (line) 2over contains if  2drop i unloop exit  then       loop  2drop false  ;                                          : locate  ( "name" -- screen | false )                            parse-name save-string located  ;                             -->                                                             ( need ) \ scr 3                                                4 border                                                        : ?located  ( screen | false -- )  dup 0= 29 ?error  ;          : from  ( "name" -- )  locate ?located first-locatable !  ;     : reneeded  ( ca len -- )  located ?located load  ;             : reneed  ( "name" -- )  parse-name save-string reneeded  ;     : needed  ( ca len -- )                                           2dup undefined?  if  reneeded  else  2drop  then  ;           : need  ( "name" -- )  parse-name save-string needed  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( Error messages 1..15 ) \ scr 4                                \ Error #01: Not a word nor a number.                           \ Error #02: Stack empty.                                       \ Error #03: Dictionary overflow.                               \ Error #04: Warning: Is not unique.                            \ Error #05: Word not found.                                    \ Error #06: Out of disk range                                  \ Error #07: Stack overflow.                                    \ Error #08: Stack imbalance.                                   \ Error #09: Trying to load from screen 0.                      \ Error #10:                                                    \ Error #11:                                                    \ Error #12:                                                    \ Error #13:                                                    \ Error #14: Wrong digit.                                       \ Error #15: Deferred word is uninitialized.                    ( Error messages 16..30 )  \ scr 5                              \ Error #16: Assertion failed.                                  \ Error #17: Compilation only, use in definition.               \ Error #18: Execution only.                                    \ Error #19: Conditionals not paired.                           \ Error #20: Definition not finished.                           \ Error #21:                                                    \ Error #22: Use only when loading.                             \ Error #23: Off current editing screen.                        \ Error #24:                                                    \ Error #25: Unsupported tape operation.                        \ Error #26: Unsupported disk operation.                        \ Error #27: Source file needed.                                \ Error #28: Warning: Not present, though required.             \ Error #29: Required, but not located.                         \ Error #30: Relative jump too long.                            ( Error messages 31..46 )  \ scr 6                              \ G+DOS error #00: Nonsense in G+DOS                            \ G+DOS error #01: Nonsense in GNOS                             \ G+DOS error #02: Statement end error                          \ G+DOS error #03: Break requested                              \ G+DOS error #04: Sector error                                 \ G+DOS error #05: Format data lost                             \ G+DOS error #06: Check disk in drive                          \ G+DOS error #07: No +SYS file                                 \ G+DOS error #08: Invalid file name                            \ G+DOS error #09: Invalid station                              \ G+DOS error #10: Invalid device                               \ G+DOS error #11: Variable not found                           \ G+DOS error #12: Verify failed                                \ G+DOS error #13: Wrong file type                              \ G+DOS error #14: Merge error                                  ( Error messages 47..62 )  \ scr 7                              \ G+DOS error #15: Code error                                   \ G+DOS error #16: Pupil set                                    \ G+DOS error #17: Invalid code                                 \ G+DOS error #18: Reading a write file                         \ G+DOS error #19: Writing a read file                          \ G+DOS error #20: O.K. G+DOS                                   \ G+DOS error #21: Network off                                  \ G+DOS error #22: Wrong drive                                  \ G+DOS error #23: Disk write protected                         \ G+DOS error #24: Not enough space on disk                     \ G+DOS error #25: Directory full                               \ G+DOS error #26: File not found                               \ G+DOS error #27: End of file                                  \ G+DOS error #28: File name used                               \ G+DOS error #29: No G+DOS loaded                              ( Error messages 63..78 )  \ scr 7                              \ G+DOS error #30: STREAM used                                  \ G+DOS error #31: CHANNEL used                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( evaluate )                                                    : evaluate  ( ca len -- )  ['] interprent execute-parsing  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( parse-char )                                                  : parse-char  ( "c"  -- c )  stream c@ 0 parsed  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( s\" )  \ ==strings==                                          only forth definitions                                          need wid-of  need parse-char                                    vocabulary escaped-voc                                          wid-of escaped-voc constant escaped-wordlist                    also escaped-voc definitions                                    7 1 2constant a  8 1 2constant b  27 1 2constant e              12 1 2constant f  10 1 2constant l  13 1 2constant n            char " 1 2constant q  13 1 2constant r  9 1 2constant t         11 1 2constant v  0 1 2constant z                               char " 1 2constant "  char \ 1 2constant \                      : m  ( -- c1 c2 2 )  10 13 2  ;                                 : (x)  ( "c" -- n )  parse-char upper 16 digit 0= 14 ?error  ;  : x  ( "cc" -- c 1 )  (x) 16 * (x) + 1  ;                       -->                                                                                                                             ( s\" )                                                         only forth definitions                                          need char>string   need search-wordlist                         need chars>string  need s+                                      : unescape-char  ( c -- c1..cn n )                                dup char>string escaped-wordlist search-wordlist                if  nip execute  else  [char] \ 2  then  ;                    : (s\")  ( "text<quote>"  -- ca len )                             pad 0  \ empty string to start with                             begin  parse-char dup [char] " <>  while  \ not finished?         dup [char] \ =  \ possibly escaped char?                        if    drop parse-char unescape-char                             else  1  then  chars>string s+                                repeat  drop  ;                                               : s\"  ( "text<quote>"  - ca len )  \ Forth 2012                  (s\")  comp? if  postpone sliteral  then  ; immediate         ( char>string chars>string )                                    : char>string  ( c -- ca len )  1 allocate-string tuck c! 1  ;  : chars>string  ( c1..cn n -- ca len )                            dup if                                                            dup allocate-string swap 2dup 2>r  ( c1..cn ca n )              bounds do  i c!  loop  2r>                                    else  pad swap  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( +place )                                                      : +place  ( ca1 len1 ca2 )                                        2dup c@ + over c!  dup c@ 1+ + smove  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( s+ )                                                          [defined] lengths                                               ?\ : lengths   2over nip over  ;                                   ( ca1 len1 ca2 len2 -- ca1 len1 ca2 len2 len1 len2 )         : s+  ( ca1 len1 ca2 len2 -- ca3 len3 )                           lengths + >r           ( ca1 len2 ca2 len2 ) ( r: len3 )        r@ allocate-string >r  ( r: len3 ca3 )                          2 pick r@ +            ( ca1 len1 ca2 len2 len1+ca3 )           smove                  ( ca1 len1 )  \ 2nd string to buffer     r@ smove               \  1st string to buffer                  r> r>  ;                                                                                                                                                                                                                                                                                                                                                                                      ( s' )                                                          : s'  ( compilation: "ccc<'>" -- ) ( run-time:  -- ca len )       [char] ' (s)  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( -rot )  \ ==datastack==                                       code -rot  ( x1 x2 x3 -- x3 x1 x2 )                               E1 c, D1 c,      \ pop hl / pop de                              E3 c,            \ ex (sp),hl                                   EB c,            \ ex de,hl                                     C3 c, pushhlde , \ jp pushhlde                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( 2nip )                                                        code 2nip  ( x1 x2 x3 x4 -- x3 x4 )                               E1 c,            \ pop hl                                       D1 c,            \ pop de                                       F1 c,            \ pop af                                       F1 c,            \ pop af                                       C3 c, pushhlde , \ jp pushhlde                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( n>r )  \ ==returnstack==                                      need z80-asm                                                    code n>r  ( x1..xn n -- ) ( R: -- x1..xn n )                      exx                                                             bc pop  0000 bc stp  |mark                                      rp fthl                                                         begin  bc tstp  nz while                                          de pop  hl decp  d m ld  hl decp  e m ld  bc decp             repeat                                                          0000 de ldp# |resolve                                           hl decp  d m ld  hl decp  e m ld                                rp sthl  exx  jpnext                                            end-code                                                      need nr>                                                                                                                                                                                        ( nr> )                                                         need z80-asm                                                    code nr>  ( -- x1..xn n ) ( R: x1..xn n -- )                      exx                                                             rp fthl                                                         m c ld  hl incp  m b ld  hl incp                                0000 bc stp  |mark                                              begin  bc tstp  nz while                                          m e ld  hl incp  m d ld  hl incp  de push  bc decp            repeat                                                          rp sthl  exx                                                    0000 hl ldp# |resolve                                           pushhl jp                                                       end-code                                                      need n>r                                                                                                                        ( rdepth )                                                      : rdepth  ( -- n )  rp@ r0 @ - -2 /  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( mode32 )  \ ==screenmodes==                                   [defined] sys-chans ?\ 23631 constant sys-chans                 [defined] sys-chars ?\ 23606 constant sys-chars                 : mode-output  ( a -- )                                           sys-chans @ 2dup ! 2dup 5 + ! 15 + !  ;                       : set-mode  ( a1 a2 -- )                                          sys-chars !  mode-output  ;                                   variable current-mode                                           : mode32  ( -- )                                                  [ latest nfa>cfa ] literal current-mode !                       2548 15360 set-mode                                             ['] (mode32-at-xy) ['] at-xy defer!  ;                        ' mode32 current-mode !                                                                                                                                                                                                                                         ( mode42 )                                                      need mode32  need <file-as-is                                   drive@ 1 drive!                                                 s" print-42" <file-as-is ?error                                 s" ea5aky.f42" <file-as-is ?error                               drive!                                                          [defined] (at-xy)                                               ?\ : (at-xy)  ( col row -- )  22 emit swap emit emit  ;         : mode42  ( -- )                                                  [ latest nfa>cfa ] literal current-mode !                       63900 [ 64600 256 - ] literal set-mode                          ['] (at-xy) ['] at-xy defer!  ;                                                                                                                                                                                                                                                                                               ( mode64 )                                                      need mode32  need <file-as-is  need 4x8font                     drive@ 1 drive!                                                 s" 4x8fd.tap" <file-as-is ?error                                drive!                                                          [defined] (at-xy)                                               ?\ : (at-xy)  ( col row -- )  22 emit swap emit emit  ;         : mode64  ( -- )                                                  [ latest nfa>cfa ] literal current-mode !                       60000 4x8font set-mode                                          ['] (at-xy) ['] at-xy defer!  ;                                                                                                                                                                                                                                                                                                                                                               ( mode64 )                                                      need z80-asm                                                    create mode64-at-flag 0 c,                                      create mode64-column 0 c,                                       create mode64-row 0 c,                                          variable mode64-chars                                           code (mode64-emit)  ( -- )                                        b a ld                                                          here 1+ 0 unresolved !  \ address of at_flag                    0 a ld#  and a                                                  z if                                                              FF a ld#                                                      then                                                            end-code                                                      : mode64  ( -- )  (mode64-emit) mode64-chars @ set-mode           ['] (at-xy) ['] at-xy defer!  ;                               ( 4x8font )                                                     create 4x8font  hex                                             02 c, 02 c, 02 c, 02 c, 00 c, 02 c, 00 c,  \  !                 52 c, 57 c, 02 c, 02 c, 07 c, 02 c, 00 c,  \ "#                 25 c, 71 c, 62 c, 32 c, 74 c, 25 c, 00 c,  \ $%                 22 c, 42 c, 30 c, 50 c, 50 c, 30 c, 00 c,  \ &'                 14 c, 22 c, 41 c, 41 c, 41 c, 22 c, 14 c,  \ ()                 20 c, 70 c, 22 c, 57 c, 02 c, 00 c, 00 c,  \ *+                 00 c, 00 c, 00 c, 07 c, 00 c, 20 c, 20 c,  \ ,-                 01 c, 01 c, 02 c, 02 c, 04 c, 14 c, 00 c,  \ ./                 22 c, 56 c, 52 c, 52 c, 52 c, 27 c, 00 c,  \ 01                 27 c, 51 c, 12 c, 21 c, 45 c, 72 c, 00 c,  \ 23                 57 c, 54 c, 56 c, 71 c, 15 c, 12 c, 00 c,  \ 45                 17 c, 21 c, 61 c, 52 c, 52 c, 22 c, 00 c,  \ 67                 22 c, 55 c, 25 c, 53 c, 52 c, 24 c, 00 c,  \ 89                 -->                                                             ( 4x8font )                                                     00 c, 00 c, 22 c, 00 c, 00 c, 22 c, 02 c,  \ :;                 00 c, 10 c, 27 c, 40 c, 27 c, 10 c, 00 c,  \ <=                 02 c, 45 c, 21 c, 12 c, 20 c, 42 c, 00 c,  \ >?                 23 c, 55 c, 75 c, 77 c, 45 c, 35 c, 00 c,  \ @A                 63 c, 54 c, 64 c, 54 c, 54 c, 63 c, 00 c,  \ BC                 67 c, 54 c, 56 c, 54 c, 54 c, 67 c, 00 c,  \ DE                 73 c, 44 c, 64 c, 45 c, 45 c, 43 c, 00 c,  \ FG                 57 c, 52 c, 72 c, 52 c, 52 c, 57 c, 00 c,  \ HI                 35 c, 15 c, 16 c, 55 c, 55 c, 25 c, 00 c,  \ JK                 45 c, 47 c, 45 c, 45 c, 45 c, 75 c, 00 c,  \ LM                 62 c, 55 c, 55 c, 55 c, 55 c, 52 c, 00 c,  \ NO                 62 c, 55 c, 55 c, 65 c, 45 c, 43 c, 00 c,  \ PQ                 63 c, 54 c, 52 c, 61 c, 55 c, 52 c, 00 c,  \ RS                 75 c, 25 c, 25 c, 25 c, 25 c, 22 c, 00 c,  \ TU                 -->                                                             ( 4x8font )                                                     55 c, 55 c, 55 c, 55 c, 27 c, 25 c, 00 c,  \ VW                 55 c, 55 c, 25 c, 22 c, 52 c, 52 c, 00 c,  \ XY                 73 c, 12 c, 22 c, 22 c, 42 c, 72 c, 03 c,  \ Z[                 46 c, 42 c, 22 c, 22 c, 12 c, 12 c, 06 c,  \ \]                 20 c, 50 c, 00 c, 00 c, 00 c, 00 c, 0F c,  \ ^_                 20 c, 10 c, 03 c, 05 c, 05 c, 03 c, 00 c,  \ ?a                 40 c, 40 c, 63 c, 54 c, 54 c, 63 c, 00 c,  \ bc                 10 c, 10 c, 32 c, 55 c, 56 c, 33 c, 00 c,  \ de                 10 c, 20 c, 73 c, 25 c, 25 c, 43 c, 06 c,  \ fg                 42 c, 40 c, 66 c, 52 c, 52 c, 57 c, 00 c,  \ hi                 14 c, 04 c, 35 c, 16 c, 15 c, 55 c, 20 c,  \ jk                 60 c, 20 c, 25 c, 27 c, 25 c, 75 c, 00 c,  \ lm                 00 c, 00 c, 62 c, 55 c, 55 c, 52 c, 00 c,  \ no                 00 c, 00 c, 63 c, 55 c, 55 c, 63 c, 41 c,  \ pq                 -->                                                             ( 4x8font )                                                     00 c, 00 c, 53 c, 66 c, 43 c, 46 c, 00 c,  \ rs                 00 c, 20 c, 75 c, 25 c, 25 c, 12 c, 00 c,  \ tu                 00 c, 00 c, 55 c, 55 c, 27 c, 25 c, 00 c,  \ vw                 00 c, 00 c, 55 c, 25 c, 25 c, 53 c, 06 c,  \ xy                 01 c, 02 c, 72 c, 34 c, 62 c, 72 c, 01 c,  \ z{                 24 c, 22 c, 22 c, 21 c, 22 c, 22 c, 04 c,  \ |}                 56 c, A9 c, 06 c, 04 c, 06 c, 09 c, 06 c,  \ ~?                 decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( spectrum-mode )                                               : spectrum-mode  ( -- )                                           ['] (emit) ['] emit defer!                                      ['] (at-xy) ['] at-xy defer!                                    ['] (home) ['] home defer!                                      ['] (cr) ['] cr defer!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( fzx-test )                                                    need fzx-emit  need <file                                       create font  2048 allot                                         1 drive!  font 0 s" lettra.fzx" <file                           font fzx-font !                                                 : zxtype  ( ca len -- )  bounds do  i c@ fzx-emit  loop  ;      cr .( fzx-emit is ready ) cr                                    ' (fzx-emit) cfa>pfa hex                                        cr .( Code start:   ) dup u.                                    cr .( Code length:  ) ' fzx-emit swap - u.                      cr                                                                                                                                                                                                                                                                                                                                                                                              ( fzx-mode )                                                    need fzx-emit                                                   : fzx-at-xy  ( xc yc -- )  fzx-y c! fzx-x c!  ;                 : fzx-cr  ( -- )  13 fzx-emit  ;                                : fzx-home  ( -- )  0 191 fzx-at-xy  ;                          : fzx-mode  ( -- )                                                ['] fzx-emit ['] emit defer!                                    ['] fzx-at-xy ['] at-xy defer!                                  ['] fzx-home ['] home defer!                                    ['] fzx-cr ['] cr defer!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                   ( fzx-emit )                                                    create fzx-font 60000 ,  \ font address                         0 constant margin  \ XXX TODO -- make it a variable             create fzx-variables                                              here 0 c, \ fzx-flags                                           here margin c, \ fzx-x (margin)                                 here 191 c,  \ fzx-y                                          constant fzx-y  constant fzx-x  constant fzx-flags              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                    need z80-asm  need scroll-1px-up                                create (fzx-emit)  ( -- )                                         asm                                                             fzx-flags hl ldp#  \ initial address of local variables         m dec  \ check fzx-flags value by decrementing it               p' if'  \ not expecting a regular character                       nz if  \ not expecting the column                                 cpl  C0 add#  \ now A = 191 - char                              hl incp                                                       then                                                            hl incp  a m ld  ret                                          then'                                                         -->                                                                                                                                                                                             ( fzx-emit )                                                      16 cp#  z if  02 m ld#  ret  then                               m inc  \ increment fzx-flags to restore previous value (0)      hl incp  \ point to fzx-x XXX why?                              fzx-font bc ftp  bc push  ix pop                                0D cp#  0000 jpz |mark 0 unresolved !                           a dec  2 ix cpx                                               -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      cy if  \ jr nc, UNDEF_CHAR                                        1F sub#  \ now A = char - 32                                    cy if  \ jr nc, PRINT_CHAR                                    2swap  \ exchange the two `if`, because they are not nested     then                                                            char ? 20 - a ld#  \ print '?' instead of invalid character       then                                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      a inc                                                           a l ld  00 h ld#  hl de ldp  hl addp  de addp                   bc addp                                                         m e ld  hl incp  m a ld  3F and#  a d ld                        m xor  rlca  rlca  a c ld                                     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      hl push  de addp  hl decp                                       exsp                                                            hl incp                                                         a xor  rld                                                      af push  rld                                                    0000 sta  |mark 1 unresolved !                                  08 cp#  \ check if char width is larger than 8 bits             rld  \ restore char shift/width                               -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      000E de ldp#  nc if  234E de ldp#  then                         0000 de stp  |mark 2 unresolved !                               hl incp  m a ld                                                 l add  a e ld                                                 -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      fzx-x hl ldp#  m a ld  c sub                                    cy if  a xor  then                                              a m ld  0000 fta  |mark 3 unresolved !                          m add                                                           0000 callc |mark 4 unresolved !  \ newline callc              -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      fzx-x bc ftp                                                    01 a ld#                                                        00 ix subx  \ now A = 1 - height                                b add  \ now A = fzx-y - height + 1                             nc if  \ end of screen                                            hl pop  hl pop  ret  \ restore the stack and exit             then                                                            af pop  BF add#                                                 22AA 2+ call  exaf                                              here jr >relmark 5 unresolved !  \ jr CHK_LOOP                -->                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                      begin  \ main loop                                                m d ld  \ now D = 1st byte from char definition grid            hl incp  \ next character definition                            2 unresolved @ >resolve                                         m c ld  hl incp                                                 a xor  exsp  exaf                                               nz if                                                             a b ld  exaf                                                    begin  d srl  c rr  rra  step                                 then                                                        -->                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                        l inc  l inc   m or  a m ld  \ put A on screen                  l dec  c a ld  m or  a m ld  \ put C on screen                  l dec  d a ld  m or  a m ld  \ put D on screen                  h inc  \ move screen address by 1 pixel down                    h a ld  07 and#                                                 z if  l a ld  20 add#  a l ld                                     nc if  h a ld  08 sub#  a h ld  then                          then \ CHK_LOOP:                                                5 unresolved @ >relresolve                                  -->                                                                                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                        exsp  \ now HL = char definition address                        l a ld                                                          e cp  \ check if reached next char definition address         z until  \ loop otherwise (to MAIN_LOOP)                        hl pop  \ discard screen address from stack                     fzx-x hl ldp#                                                   m a ld  \ now A = column                                      \ WIDTH1:                                                         here 1+ dup 1 unresolved @ ! 3 unresolved @ !                   00 add#  \ now A = column + (width - 1)                         scf                                                             01 ix adcx  \ now A = column + width + tracking               -->                                                                                                                                                                                             ( fzx-emit )                                                      cy if                                                             0 unresolved @ >resolve  4 unresolved @ >resolve                margin m ld#  \ move to initial column at left margin           hl incp                                                         m a ld  \ now A = line                                          00 ix subx  \ now A = line - height                           then                                                            a m ld  \ move down a few pixels specified by height            ret                                                             end-asm                                                       -->                                                                                                                                                                                                                                                                                                                             ( fzx-emit )                                                    code fzx-emit  ( c -- )                                           hl pop  bc push                                                 l a ld  ' (fzx-emit) cfa>pfa call                               bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( zx7 )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( udg! udg: )  \ ==graphics==                                   [defined] udg                                                     ?\  : udg  ( -- a )  23675 @  ;                               : udg!  ( b0..b7 c -- )                                           128 - 8 * udg + 1 - dup 8 + do  i c!  -1 +loop  ;             : udg:  ( b0..b7 c "name" -- )  dup constant  udg!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( xy-emit-udg )                                                 need (xy-emit)  need z80-asm                                    code xy-emit-udg  ( x y b -- )                                    hl pop  l a ld                                                  de pop  hl pop  bc push  e b ld  l c ld                         5C7B de ftp  \ system variable UDG                              (xy-emit) call                                                  bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ (xy-emit) \                                                   need z80-asm  need (pixel-addr)                                 create (xy-emit)  ( -- )                                          asm                                                             0 h ld#  a l ld  hl addp  hl addp  hl addp  de addp             hl push  ix pop  bc hl ldp  hl push  8 c ld#                    begin                                                             hl pop  h dec  hl push  h inc                                   bc push  hl bc ldp  (pixel-addr) call  bc pop                   a b ld  a xor  b or  0 ix a ftx                                 nz if   exde  0 h ld#  a l ld  8 a ld#  b sub  a b ld                   begin  hl addp  step  exde                                      m a ld  d xor  a m ld                                           hl incp  e a ld  then                                   m xor  a m ld  ix incp  c dec                                 z until  hl pop  ret  end-asm                                 ( ocr )                                                         need z80-asm need ocr-chars                                     code ocr  ( col line -- n )                                       de pop  hl pop  bc push                                         l b ld  e c ld  ocr-charset fthl                                c a ld  rrca  rrca  rrca  E0 and#  b xor  a e ld                c a ld  18 and#  40 xor#  a d ld                                0 de stp |mark 0 unresolved !                                   ocr-chars fta  a b ld                                           begin                                                             bc push  hl push                                                0 de ldp#  \ restore the screen address                         |mark 0 unresolved @ !                                      -->                                                                                                                                                                                             ( ocr )                                                             08 b ld# \ scans                                                begin                                                             de ftap  m xor  \ scan match?                                   here jrnz >relmark 1 unresolved !                               d inc  hl incp  \ update the pointers                         step  \ next scan                                               bc pop  bc pop                                                  ocr-chars fta  b sub  a b ld                                    ocr-first fta  b add  a b ld                                    here jr >relmark 2 unresolved !                                 1 unresolved @ >relresolve                                      hl pop  0008 de ldp#  de addp  bc pop                         step                                                            2 unresolved @ >relresolve  0 h ld#  b l ld                     bc pop  pushhl jp  end-code                                   ( ocr-charset ocr-first ocr-chars ascii-ocr udg-ocr )           variable ocr-charset                                            variable ocr-first                                              variable ocr-chars                                              : ascii-ocr  ( -- )                                               23606 @ 256 + ocr-charset !                                     32 ocr-first !                                                  95 ocr-chars !  ;                                             : udg-ocr  ( n -- )                                               23675 @ ocr-charset !                                           128 ocr-first !                                                 ocr-chars !  ;                                                19 udg-ocr  \ default                                                                                                                                                                                                                                           ( pixel-addr )                                                  need (pixel-addr)                                               code pixel-addr  ( xc yc -- n a )                                 E1 c,  D1 c,            \ pop hl / pop de                       C5 c,                   \ push bc                               40 05 + c,              \ ld b,l ; b=y                          48 03 + c,              \ ld c,e ; c=x                          CD c, (pixel-addr) ,       \ call (pixel-addr)                  C1 c,                   \ pop bc                                16 c, 0 c,  58 07 + c,  \ ld d,0 / ld e,a                       C3 c, pushhlde ,        \ jp pushhlde                           end-code                                                                                                                                                                                                                                                                                                                      \ (pixel-addr) \                                                create (pixel-addr)  ( -- a )                                     asm                                                             3E c, BF c,   \ ld a,191 ; max Y coordinate                     90 00 + c,    \ sub b                                           C3 c, 22B0 ,  \ jp 0x22B0 ; and return                          end-asm                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( (pixel-addr) )                                                need z80-asm                                                    create (pixel-addr)  ( -- a )                                     asm                                                             BF a ld#  b sub                                                 a b ld  rra  scf  rra  a and  rra                               b xor  F8 and#  b xor  a h ld                                   c a ld                                                          rlca rlca rlca  b xor  C7 and#                                  b xor  rlca  rlca                                               a l ld                                                          c a ld  07 and#                                                 ret                                                             end-asm                                                                                                                                                                                       ( plot )                                                        need (pixel-addr)                                               code plot  ( xc yc -- )                                           D9 c,               \ exx                                       E1 c,               \ pop hl                                    C1 c,               \ pop bc                                    40 05 + c,          \ ld b,l                                    ED c, 43 c, 5C7D ,  \ ld (0x5C7D),bc ; update COORDS            CD c, (pixel-addr) ,   \ call (pixel-addr)                      CD c, 22EC ,        \ call 0x22EB ; ROM PLOT-SUB + 7            D9 c,               \ exx                                       DD c, 21 c, next ,  \ ld ix,next ; restore ix                   jpnext              \ jp (ix)                                   end-code                                                                                                                                                                                      ( set-pixel )                                                   need (pixel-addr)  need z80-asm                                 code set-pixel  ( xc yc -- )                                      hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               m or  a m ld  \ combine pixel with byte in the screen           bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( reset-pixel )                                                 need (pixel-addr)  need z80-asm                                 code reset-pixel  ( xc yc -- )                                    hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               cpl  m and  a m ld  \ combine pixel with byte in the screen     bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( toggle-pixel )                                                need (pixel-addr)  need z80-asm                                 code toggle-pixel  ( xc yc -- )                                   hl pop  de pop  bc push                                         l b ld  e c ld  (pixel-addr) call                               a b ld  b inc  1 a ld#                                          begin  rrca  step                                               m xor  a m ld  \ combine pixel with byte in the screen          bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( pixel? )                                                      need (pixel-addr)  need z80-asm                                 code pixel?  ( xc yc -- f )                                       hl pop  de pop  bc push                                         l b ld  e c ld                                                  (pixel-addr) call                                               a b ld  b inc  m a ld                                           begin  rlca  step \ rotate to bit 0                             bc pop  \ restore the Forth IP                                  1 and#  \ pixel?                                                ' true cfa>pfa jpnz                                             ' false cfa>pfa jp                                              end-code                                                                                                                                                                                                                                                      ( rdraw )                                                       need z80-asm                                                    code rdraw  ( x y -- )                                            hl pop  de pop  bc push                                         de bc ldp                                                       1 e ld#                                                         b 7 bit  \ negative x?                                          nz if  c a ld  neg  -1 e ld#  a c ld  then  \ negative x        l b ld   \ y                                                    1 d ld#                                                         h 7 bit  \ negative y?                                          nz if  b a ld  neg  -1 d ld#  a b ld  then  \ negative y        24BA call \ alternative entry to the DRAW-LINE ROM routine      bc pop                                                          jpnext end-code                                                                                                               ( adraw ) \ from Abersoft Forth                                 need plot                                                       2variable x1  2variable incx  2variable y1  2variable incy      : adraw  ( x y -- )                                               23678 c@ ( y0 ) dup 0 swap y1 2! - dup abs rot                  23677 c@ ( x0 ) dup 0 swap x1 2! - dup abs rot                  max >r dup 0<  \ negative xdiff?                                if    abs 0 swap r@ m/mod dnegate                               else  0 swap r@ m/mod  then                                     incx 2! drop dup 0<  \ negative ydiff?                          if    abs 0 swap r@ m/mod dnegate                               else  0 swap r@ m/mod  then                                     incy 2! drop r> 1+ 0                                            do  x1 @ y1 @ plot                                                  x1 2@ incx 2@ d+ x1 2!                                          y1 2@ incy 2@ d+ y1 2!  loop  ;                           ( attr )                                                        need z80-asm need (attr-addr)                                   code attr ( col line -- b )                                       de pop  hl pop  l d ld                                          (attr-addr) call                                                m l ld  0 h ld#                                                 pushhl jp                                                       end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( attr-addr )                                                   need z80-asm need (attr-addr)                                   code attr-addr ( col line -- a )                                  de pop  hl pop  l d ld                                          (attr-addr) call                                                pushhl jp                                                       end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \ (attr-addr) \                                                 need z80-asm                                                    create (attr-addr)  ( -- a )                                      asm                                                             e a ld  \ line to a 0x00..0x17 (max 00010111)                   rrca rrca rrca  \ rotate bits left                              a e ld  \ store in d as an intermediate value                   E0 and#  \ pick up bits 11100000 (was 00011100)                 d xor  \ combine with column 0x00..0x1F                         a l ld  \ low byte now correct                                  e a ld  \ bring back intermediate result from d                 03 and#  58 xor#                                                a h ld  \ high byte correct                                     ret                                                             end-asm                                                                                                                       ( circle )                                                      need z80-asm                                                    create circle-plot  ( -- a )                                      asm                                                             hl push  bc push  de push                                       ' plot cfa>pfa call  \ XXX TODO                                 de pop  bc pop  hl pop  ret                                     end-asm                                                       code circle  ( x y radius -- )                                    0 h ld#  l a ld                                                 exx  cpl  a c ld  FF b ld#                                      bc incp  \ bc' is -radius                                       end-code                                                                                                                                                                                                                                                      ( fade )                                                        need z80-asm                                                    code fade  ( -- )                                                 bc push                                                         8 b ld#                                                         begin  5AFF hl ldp#  halt  halt                                   begin                                                             m a ld  a d ld  07 and#  nz if  a dec  then                     a e ld  a d ld  38 and#  nz if  8 sub#  then                    e or  d xor  3F and#  d xor                                     a m ld  hl decp  h a ld                                         58 cp#                                                        cy until                                                      step                                                            bc pop  jpnext                                                  end-code                                                      ( inverted )                                                    need z80-asm                                                    code inverted  ( -- )                                             4000 hl ldp#                                                    begin   m a ld  cpl  a m ld                                             hl incp  h a ld  58 cp#                                         jrnz                                                    jpnext                                                          end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( water )                                                       need z80-asm                                                    code water  ( -- )                                                bc push                                                         20 b ld#                                                        begin    57FF hl ldp#                                                     begin   m rrc  hl decp  h 6 bit  z until                        step                                                  bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( clsx )                                                        need z80-asm                                                    code clsx  ( -- )                                                 bc push                                                         6 b ld#                                                         begin   bc push  57FF hl ldp#                                           begin   20 c ld#  a and                                                 begin   nop  m sla                                                      nop  m rlc                                                      nop  m sla                                                      nop  hl decp  c dec  z until                            3F a ld#  h cp  z until                                 bc pop  step                                            bc pop  jpnext                                                  end-code                                                                                                                      ( scroll-1px-right )                                            need z80-asm                                                    code scroll-1px-right  ( -- )                                     bc push                                                         4000 hl ldp#  \ screen bitmap address                           C0 c ld#  \ pixel rows                                          begin                                                                   m srl  hl incp  \ first char column                             1F b ld#  \ remaining columns                                   begin   m rr  hl incp  step                                     c dec                                                           z until                                                 bc pop jpnext                                                   end-code                                                                                                                                                                                      ( scroll-1px-up )                                               need z80-asm                                                    create (scroll-1px-up)  ( -- a )                                  asm                                                             4000 hl ldp#  BF b ld#                                          begin                                                             bc push  hl de ldp  h inc  h a ld  F8 and#  h cp                z if    8 b ld#  b sub  rra  rra  rra  a h ld  0020 bc ldp#             bc addp  h a ld  rla  rla  rla  a h ld                  then    hl push  0020 bc ldp#  ldir  hl pop  bc pop           step                                                            end-asm                                                       code scroll-1px-up  ( -- )                                        bc push  \ Forth IP                                             (scroll-1px-up) call                                            bc pop  jpnext  end-code                                      ( xy-scroll )                                                   need z80-asm                                                    code xy-scroll  ( -- )                                            bc push                                                         08 b ld#                                                        begin                                                             4000 hl ldp#  \ screen bitmap address                           begin                                                             m srl  hl incp                                                  m sla  hl incp                                                  58 a ld#  h cp                                                  z until                                                       step                                                          bc pop  end-code                                                                                                                                                                              ( horizontal-curtain )                                          need z80-asm                                                    code horizontal-curtain  ( b -- )                                 de pop  bc push                                                 e a ld  5800 de ldp#  5AFF hl ldp#                              0C b ld#                                                        begin   bc push  20 b ld#                                               begin   a m ld  de stap                                                 bc push  02 b ld#                                               begin bc push  FF b ld#  begin  step                                  bc pop  step                                              bc pop  de incp  hl decp  step                          bc pop  step                                            bc pop  jpnext                                                  end-code                                                                                                                      ( vertical-curtain )                                            need z80-asm                                                    code vertical-curtain  ( b -- )                                   de pop  bc push                                                 e a ld  5800 de ldp#  5AFF hl ldp#  10 b ld#                    begin   bc push  18 b ld#  de push  hl push                             begin   a m ld  de stap  bc push  02 b ld#                              begin   bc push  FF b ld#  begin  step                                  bc pop  step                                            20 b ld#                                                        begin  de incp  hl decp  step                                   bc pop  step                                            hl pop  de pop  bc pop  de incp  hl decp  step          bc pop  jpnext  end-code                                                                                                                                                                      ( !sound vol shutup noise )  \ ==sound128==                     need !p                                                         [defined] sound-register-port                                     ?\ 65533 constant sound-register-port                         [defined] sound-write-port                                        ?\ 49149 constant sound-write-port                            : !sound  ( b1 b2 -- )                                            sound-register-port !p sound-write-port !p  ;                 : vol  ( n1 n2 -- )  8 + !sound  ;                              : shutup  ( -- )  -1 7 !sound  ;  \ XXX FIXME                   : noise  ( -- )  7 7 !sound  ;                                                                                                                                                                                                                                                                                                                                                                  ( music )                                                       need ms  vocabulary music  current @  also music definitions    : freq                                                            2* 109.375 3 roll  um/mod nip 256 /mod 2 pick                   1+ !sound  swap !sound  ;                                     variable len  variable tempo  variable octave  variable volume  2 len !  200 tempo !  8 octave !  15 volume ! 1 15 vol          : tones  ( -- )  56 7 !sound  ;                                 : note  ( n "name" -- )                                           create  ,                                                       does>   @ octave @ * 16 /  1 freq tones                                 tempo @ len @ * ms shutup  ;                          523 note c  554 note c# 583 note d  622 note d#                 659 note e  698 note f  740 note f# 784 note g                  831 note g# 880 note a  932 note a# 988 note b                  -->                                                             ( music )                                                       : l  ( n -- )  len !  ;                                         : o+  ( -- )  octave @ 2 * octave !  ;                          : o-  ( -- )  octave @ 2 / octave !  ;                          : r  ( -- )  tempo @ len @ * ms  ;                              : >>  ( -- )  1 volume @ 1+ vol 1 volume +!  ;                  : <<  ( -- )  1 volume @ 1- vol -1 volume +!  ;                 current ! previous                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( play sound: )                                                 need !p                                                         [defined] sound-register-port                                     ?\ 65533 constant sound-register-port                         [defined] sound-write-port                                        ?\ 49149 constant sound-write-port                            : play  ( a -- )                                                  14 0 do                                                           i sound-register-port !p  dup c@ sound-write-port !p 1+       loop  drop  ;                                                 : sound:  ( b0 ... b13 "name" -- )                                create  here 1- 14 allot here -1 do  i c!  -1 +loop  ;                                                                                                                                                                                                                                                                        ( play )                                                        need z80-asm                                                    [defined] sound-register-port                                   ?\ 65533 constant sound-register-port                           [defined] sound-write-port                                      ?\ 49149 constant sound-write-port                              code play  ( a -- )                                               hl pop  bc push                                                 0E b ld#  00 e ld#                                              begin   bc push                                                         e a ld  sound-register-port bc ldp#  a outbc                    m a ld  sound-write-port bc ldp#  a outbc                       hl incp  e inc  bc pop  \ next                          step                                                            bc pop  jpnext                                                  end-code                                                      ( waves shoot helicopter train )                                create waves  ( -- a )                                            0 c,  0 c,  0 c,  0 c,  0 c,  0 c,  7 c,                        71 c,  20 c,  20 c,  20 c,  0 c,  38 c,  14 c,                create shoot  ( -- a )                                            10 c,  0 c,  177 c,  0 c,  191 c,  0 c,  31 c,                  71 c,  20 c,  20 c,  20 c,  92 c,  28 c,  3 c,                create helicopter  ( -- a )                                       200 c,  15 c,  200 c,  15 c,  200 c,  15 c,  0 c,               7 c, 23 c,  23 c,  23 c,  255 c,  1 c,  12 c,                 create train  ( -- a )                                            100 c,  120 c,  48 c,  97 c,  12 c,  200 c,  55 c,              15 c,  9 c,  11 c,  55 c,  180 c,  4 c,  8 c,                                                                                                                                                                                                                 ( sound effects )                                               need sound:  hex                                                00 00 00 00 00 00 1E 40 0F 10 0F 00 07 18 sound: aplausse       1B 00 09 00 00 00 1F C8 10 10 10 00 6B 10 sound: hammer         AB 03 2A 02 0C 01 00 F8 10 10 10 00 71 10 sound: bell1          66 00 4B 00 45 00 00 F8 10 10 10 00 22 10 sound: bell2          FC 06 DE 03 C3 04 00 F8 10 10 10 00 FF 10 sound: bell3          0C 1F 00 00 00 1F 07 E8 0F 10 0F 9A 00 18 sound: airplane       09 00 00 06 0C 00 0B C0 10 0E 10 3A 02 1C sound: helicopter     03 05 FC 04 0C 05 00 F8 10 10 10 FF FF 0E sound: background     00 00 00 00 00 00 06 C0 10 10 10 00 05 18 sound: rap            00 06 00 00 00 05 11 E8 10 10 10 00 0A 10 sound: drum           09 00 00 00 00 00 00 C0 10 10 10 03 09 10 sound: cymbal         00 00 00 00 00 00 0F C0 0B 10 10 FF 50 0E sound: beach          24 00 12 00 16 00 00 F8 10 10 10 00 10 18 sound: waterdrop        decimal                                                       ( rain water-drops )                                            create rain  ( -- a )                                             44 c, 24 c, 6 c, 6 c, 7 c, 3 c, 3 c,                            5 c, 44 c, 6 c, 3 c, 5 c, 3 c, 3 c,                           create water-drop  ( -- a )                                       20 c, 83 c, 94 c, 39 c, 0 c, 8 c, 31 c,                         71 c, 23 c, 23 c, 22 c, 90 c, 0 c, 0 c,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( bleep )  \ ==sound48==                                        code bleep  ( n1 n2 -- )                                          E1 c, D1 c, C5 c,   \ pop hl / pop de / push bc                 CD c, 03B5 ,        \ call rom_beeper                           C1 c,               \ pop bc                                    DD c, 21 c, next ,  \ ld ix,next ; restore ix                   jpnext              \ jp (ix)                                   end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( beep>bleep )                                                  : beep>bleep  ( freq duration -- n1 n2 )                          over 1000 */ swap                                               4375 100 rot */ 30 -  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( laser-gun )                                                   need z80-asm                                                    code laser-gun  ( -- )                                            bc push                                                         5 b ld#                                                         0500 hl ldp#                                                    begin   0001 de ldp#                                                    hl push  03B5 call  hl pop  \ ROM beeper                        0010 de ldp#  de subp                                           jrnz                                                    bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                                                                                                                                                      ( white-noise )                                                 need z80-asm                                                    code white-noise  ( u -- )                                        de pop                                                          bc push  \ save the Forth IP                                    de bc ldp  0000 hl ldp#  \ bc=duration, hl=start of ROM         5C48 fta  a sra  a sra  a sra  07 and#  a d ld                  begin   m e ld  hl incp  bc decp  bc push                               08 b ld#  \ bit counter                                         begin   e a ld  10 and#  e rl  d or  FE out  \ beep                     step                                                    bc pop  bc tstp                                                 jrnz                                                    bc pop  jpnext \ restore the Forth IP and go next               end-code                                                                                                                      ( ambulance )                                                   need z80-asm                                                    code ambulance  ( n -- )                                          de pop  bc push  e b ld                                         begin   bc push  0320 hl ldp#  000A de ldp#                             <mark   hl push                                                         03B5 call  \ ROM beeper                                         hl pop  hl decp                                                 hl tstp                                                         jrnz                                                    bc pop                                                          step                                                    bc pop  next ix ldp#  jpnext                                    end-code                                                                                                                                                                                      ( exchange )  \  ==memoryaccess==                               : exchange  ( n1 a -- n2 )  dup @ rot rot !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( command )                                                     need source  need /string                                       : command  ( "text<eol>" -- ca len )                              source span @ min c/l min  >in @ span @ min /string             dup >in +! save-string  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( under+ )  \ ==operators==                                     : under+  ( n1 n2 n3 -- n4 n3 )  >r + r>  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( within between )                                              : within  ( n1|u1 n2|u2 n3|u3 -- f )                              over - >r - r> u<  ;                                          need -rot                                                       : between  ( n1|u1 n2|u2 n3|u3 -- f )                             over - -rot - u< 0=  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( d0= d0< d< du< dmin dmax )                                    : d0=  ( d -- f )  or 0=  ;                                     : d0<  ( d -- f )  nip 0<  ;                                    ; d<  ( d1 d2 -- f )                                              rot 2dup = if  2drop u< exit  then  2nip >  ;                 : du<  ( ud1 ud2 -- f )                                           rot swap 2dup                                                   u<  if  2drop 2drop -1 exit  then                               -   if  2drop 0 exit  then  u<  ;                             : dmin  ( d1 d2 -- d1 | d2 )                                      2over 2over d< 0= if  2swap  then  2drop  ;                   : dmax  ( d1 d2 -- d1 | d2 )                                      2over 2over d< if  2swap  then  2drop  ;                                                                                                                                                                                                                      ( lshift )                                                      code lshift  ( x1 u -- x2 )                                       D1 c,           \ pop de                                        E1 c,           \ pop hl                                        1C c,           \ inc e                                         here            \ begin:                                        1D c,           \ dec e                                         CA c, pushhl ,  \ jp z,push_hl                                  29 c,           \ add hl,hl                                     C3 c, ,         \ jp begin                                      end-code                                                                                                                                                                                                                                                                                                                                                                                      ( rshift )                                                      code rshift  ( x1 u -- x2 )                                       D1 c,           \ pop de                                        E1 c,           \ pop hl                                        1C c,           \ inc e                                         here            \ begin:                                        1D c,           \ dec e                                         CA c, pushhl ,  \ jp z,push_hl                                  C3 c, ,         \ jp begin                                      end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( Symmetric-division operators )                                : /-rem  ( n1 n2 -- n3 n4 )  >r  s>d  r> sm/rem  ;              : /-  (  n1 n2 -- n3 )  /-rem nip  ;                            : -rem  ( n1 n2 -- n3 )  /-rem drop  ;                          : */-rem  (  n1 n2 n3 -- n4 n5 )  >r  m*  r> sm/rem  ;          : */-  ( n1 n2 n3 -- n4 )  */-rem nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( Floored-division operators )                                  : /_mod  ( n1 n2 -- n3 n4)  >r s>d r> fm/mod  ;                 : /_  ( n1 n2 -- n3)  /_mod nip  ;                              : _mod  ( n1 n2 -- n3)  /_mod drop  ;                           : */_mod  ( n1 n2 n3 -- n4 n5)  >r m* r> fm/mod  ;              : */_  ( n1 n2 n3 -- n4 )   */_mod nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( fig-Forth +- d+- )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ( any? )                                                        : any?  ( n1..nn n n0 -- f )                                      ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( [if] [else] [then] )  \ ==conditionalcompilation==            [defined] s=  ?\  : s=  ( ca1 len1 ca2 len2 )  compare 0=  ;    : [else]  ( "..." -- )                                            1 begin   parse-name 2dup swap c@ and                             while   2dup s" [if]" s=                                                if    2drop 1+                                                  else  2dup s" [else]" s=                                              if    2drop 1- dup if  1+  then                                 else  s" [then]" s= if  1-  then                                then                                                      then  ?dup 0= if  exit  then                          repeat  2drop drop  ; immediate                               : [if]  ( "..." -- )  0= if postpone [else] then  ; immediate   : [then]  ( -- )  ; immediate                                                                                                                                                                   ( ufia )  \ ==g+dos==                                           24 constant /ufia  create ufia  /ufia allot  ufia /ufia erase   ufia      constant dstr1 \ drive: 1 or 2                        ufia 1+   constant fstr1 \ program number                       ufia 2+   constant sstr1 \ stream number                        ufia 3 +  constant device \ device: "D" or "d"                  ufia 4 +  constant nstr1 \ directory description                ufia 5 +  constant nstr2 \ file name                            ufia 15 + constant hd00  \ file type                            ufia 16 + constant hd0b  \ file length                          ufia 18 + constant hd0d  \ file start address                   char d device c! \ "d" or "D"                                   2 sstr1 c! \ stream 2                                           1 dstr1 c! \ drive 1                                            variable file-length                                            variable file-address                                           ( File types and directory descriptions)                        0 constant basic-filetype  1 constant data-array-filetype       2 constant string-array-filetype  3 constant code-filetype        01 constant basic-file      02 constant data-array              03 constant string-array    04 constant code-file               05 constant snapshot-48k    06 constant microdrive-file         07 constant screens$-file   08 constant special-file            09 constant snapshot-128k   10 constant opentype-file           11 constant execute-file                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( --hook-codes-- )                                              hex                                                             33 constant hxfer  34 constant ofsm  35 constant hofile         36 constant sbyte  37 constant hsvbk 38 constant cfsm           39 constant pntp   3A constant cops  3B constant hgfile         3C constant lbyte  3D constant hldbk 3E constant wsad           3F constant sad    40 constant rest  41 constant heraz          42 constant cops2  43 constant pcat  44 constant hrsad          45 constant hwsad  46 constant otfoc 47 constant patch          decimal                                                         : --hook-codes--  ;                                                                                                                                                                                                                                                                                                                                                                             ( ior>error ?dos-error )                                        : ior>error  ( ior -- f n )                                       dup 1 and negate  \ error?                                      swap 255 /        \ error code                                  dup 128 and       \ ZX Spectrum error?                          if  negate  else  31 +  then   ;                              : ?dos-error  ( ior -- )                                          ior>error ?error  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( drive@ drive! )                                               need z80-asm  need --hook-codes--                               code drive@  ( -- n )                                             bc push  \ save the Forth registers                             patch hook                                                      3ACE fta  \ XXX NEW                                             E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             pusha jp  end-code                                            code drive!  ( n -- )                                             hl pop                                                          bc push  \ save the Forth registers                             l a ld  21 hook   \ select drive in a                           bc pop   next ix ldp#  \ restore the Forth registers            jpnext  end-code                                                                                                              ( -file )                                                       need z80-asm  need ufia  need --hook-codes--                    code (-file)  ( -- ior )                                          bc push  \ save the Forth registers                             ufia ix ldp#                                                    heraz hook \ erase the file                                     bc pop  next ix ldp#  \ restore the Forth registers             af push                                                         jpnext                                                          end-code                                                      need ior>error                                                  : -file  ( ca len -- f n )                                        filename>ufia (-file) ior>error  ;                                                                                                                                                                                                                            ( -filename filename! >ufia filename>ufia )                     need ufia  need drive@                                          10 constant /filename  \ max filename length                    : -filename  ( -- )  nstr2 /filename blank  ;                   : filename!  ( ca len -- )                                        -filename /filename min nstr2 swap cmove  ;                   : >ufia  ( a1 len1 ca2 len2 -- )                                  3 hd00 c!  4 nstr1 c!  \ code filetype and dir description      filename!                                                       dup hd0b !  file-length !                                       dup hd0d !  file-address !                                      drive@ dstr1 c!  ;                                            1 drive!  \ default                                             : filename>ufia  ( ca len -- )  0 0 2swap >ufia  ;                                                                                                                                              ( >file )                                                       need z80-asm  need ufia  need --hook-codes--                    need >ufia  need ior>error                                      code (>file)  ( -- ior )                                          bc push  \ save the Forth registers                             ufia ix ldp#                                                    hofile hook \ open the file and create its header               nc if \ no error?                                                 hd0d de ftp  hd0b bc ftp  \ de=start, bc=length                 hsvbk hook \ save to file                                       nc if  cfsm hook  then  \ close the file if no error          then  bc pop  next ix ldp#  \ restore the Forth registers       af push  \ ior                                                  jpnext end-code                                               : >file  ( a1 len1 ca2 len2 -- f n )                              >ufia (>file) ior>error  ;                                    ( <file )                                                       need z80-asm  need ufia  need --hook-codes--                    need >ufia  need ior>error                                      code (<file)  ( -- ior )                                          bc push  \ save the Forth IP                                    ufia ix ldp#  hgfile hook \ get the file                        nc if \ no error?  -- load the file header:                       hd00 de ldp#  9 b ld# \ destination and count                   begin  lbyte hook  de stap  de incp  step                       file-address de ftp  file-length bc ftp                         bc tstp z if  hd0b bc ftp  then  hldbk hook                   then  bc pop  next ix ldp#  af push                             jpnext  end-code                                              : <file  ( a1 len1 ca2 len2 -- f n )                              >ufia (<file) ior>error  ;                                                                                                    ( <file-as-is )                                                 need z80-asm  need ufia  need --hook-codes--                    need >ufia  need ior>error                                      code (<file-as-is)  ( -- ior )                                    bc push  \ save the Forth IP                                    ufia ix ldp#  hgfile hook \ get the file                        nc if \ no error?  -- load the file header:                       hd00 de ldp#  9 b ld# \ destination and count                   begin  lbyte hook  de stap  de incp  step                       hd0d de ftp  hd0b bc ftp  hldbk hook                          then  bc pop  next ix ldp#  af push                             jpnext  end-code                                              : <file-as-is  ( ca len -- f n )                                  0 0 2swap >ufia (<file-as-is) ior>error  ;                                                                                                                                                    ( file? )                                                       need ufia  need filename!  need --hook-codes--                  code (file?)  ( -- f )                                            bc push  \ save the Forth IP                                    patch hook                                                      nstr2 ix ldp#                                                   1146 call  \ FIND_FILE                                          168E call  \ BORD_REST = restore the border                     E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             ' true cfa>pfa jpz                                              ' false cfa>pfa jp                                              end-code                                                      : file?  ( ca len -- f )  filename! (file?)  ;                                                                                                                                                  ( cat acat wcat wacat )                                         need z80-asm  need ufia  need --hook-codes--                    need filename>ufia                                              [defined] ufia1  ?\ hex 3E01 constant ufia1 decimal             code (cat)  ( n -- )                                              hl pop  bc push  exx                                            patch hook                                                      ufia hl ldp#  ufia1 de ldp#  /ufia bc ldp#  ldir                exx  l a ld  24B5 call  168E call                               E7 out  bc pop  next ix ldp#  jpnext  end-code                : wcat  ( ca len -- )  filename>ufia  4 (cat)  ;                : wacat  ( ca len -- )  filename>ufia  2 (cat)  ;  decimal      : cat  ( ca len -- )  s" *" wcat  ;                             : acat  ( ca len -- )  s" *" wacat ;  decimal                                                                                                                                                   ( @dos )                                                        need z80-asm  need --hook-codes--                               code @dos  ( a -- n )                                             hl pop                                                          bc push  \ save the Forth IP                                    hl push                                                         patch hook                                                      hl pop m e ld  hl incp  m d ld                                  E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             de push                                                         jpnext                                                          end-code                                                                                                                                                                                                                                                      ( c@dos )                                                       need z80-asm  need --hook-codes--                               code c@dos  ( a -- b )                                            hl pop                                                          bc push  \ save the Forth IP                                    hl push                                                         patch hook                                                      hl pop                                                          m a ld                                                          E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             pusha jp                                                        end-code                                                                                                                                                                                                                                                      ( c!dos )                                                       need z80-asm  need --hook-codes--                               code c!dos  ( b a -- )                                            hl pop  de pop                                                  bc push  \ save the Forth IP                                    de push hl push                                                 patch hook                                                      hl pop  de pop  e m ld                                          E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             jpnext                                                          end-code                                                                                                                                                                                                                                                                                                                      ( !dos )                                                        need z80-asm  need --hook-codes--                               code !dos  ( n a -- )                                             hl pop  de pop                                                  bc push  \ save the Forth IP                                    de push  hl push                                                patch hook                                                      hl pop  de pop  e m ld  hl incp  d m ld                         E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             jpnext                                                          end-code                                                                                                                                                                                                                                                                                                                      ( @dosvar )                                                     need z80-asm  need --hook-codes--                               [defined] dos-vars ?\ 8192 constant dos-vars                    code @dosvar  ( n1 -- n2 )                                        hl pop                                                          bc push  \ save the Forth IP                                    hl push                                                         patch hook                                                      hl pop  dos-vars de ldp#  de addp                               m e ld  hl incp  m d ld                                         E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             de push                                                         jpnext                                                          end-code                                                                                                                      ( c@dosvar )                                                    need z80-asm  need --hook-codes--                               [defined] dos-vars ?\ 8192 constant dos-vars                    code c@dosvar  ( n -- b )                                         hl pop                                                          bc push  \ save the Forth IP                                    hl push                                                         patch hook                                                      hl pop  dos-vars de ldp#  de addp                               m a ld                                                          E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             pusha jp                                                        end-code                                                                                                                                                                                      ( !dosvar )                                                     need z80-asm  need --hook-codes--                               [defined] dos-vars ?\ 8192 constant dos-vars                    code !dosvar  ( n1 n2 -- )                                        hl pop  de pop                                                  bc push  \ save the Forth IP                                    de push  hl push                                                patch hook                                                      hl pop  dos-vars de ldp#  de addp  de pop                       e m ld  hl incp  d m ld                                         E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             jpnext                                                          end-code                                                                                                                                                                                      ( c!dosvar )                                                    need z80-asm  need --hook-codes--                               [defined] dos-vars ?\ 8192 constant dos-vars                    code c!dosvar  ( b n -- )                                         hl pop  de pop                                                  bc push  \ save the Forth IP                                    de push hl push                                                 patch hook                                                      hl pop  dos-vars de ldp#  de addp  de pop                       e m ld                                                          E7 out  \ page +D out                                           bc pop  next ix ldp#  \ restore the Forth registers             jpnext                                                          end-code                                                                                                                                                                                      ( update flush continued ?load )  \ ==diskblocks==              : update  ( -- )                                                  disk-buffer @                                                   [ base @ hex ] 8000 [ base ! ] or                               disk-buffer !  ;                                              : flush  ( -- )  save-buffers empty-buffers  ;                  : continued  ( u -- )  ?loading (load)  ;                       : ?load  ( scr f -)  if  dup load  then  drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( transient[ )  \ ==tools==                                     variable old-dp                                                 variable old-np                                                 variable old-latest                                             variable old-voc-link                                           : transient[  ( u -- )                                            here        old-dp !                                            np@         old-np !                                            latest      old-latest !                                        voc-link @  old-voc-link !                                      0 swap - dp !  ;                                              : ]transient  ( -- )                                              old-dp @ dp !  old-np @ np !  ;                               : -transient  ( -- )                                              old-voc-link @ voc-link !                                       old-latest @ old-np @ cfap>lfa !n  ;                          ( [false] [true] )                                                       0 constant [false] immediate                           [false] 0= constant [true]  immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( hex. hexb. dhex. <hex hex> )                                  [defined] base'  ?\ variable base'                              [defined] (d.)                                                  ?\ : (d.)  ( d n -- ca len )  <# 0 do  #  loop  #>  ;           : <hex  ( -- )  base @ base' ! hex ; \ switch to hex            : hex>  ( -- )  base' @ base !     ; \ and back                 : (dhex.)  ( d n -- )  <hex (d.) hex> type space  ;             : dhex.    ( d -- )  8 (dhex.)  ;                               : hex.     ( n -- )  s>d 4 (dhex.)  ;                           : hexb.    ( b -- )  s>d 2 (dhex.)  ;                                                                                                                                                                                                                                                                                                                                                                                                                           ( binary bin. binb. dbin. <bin bin> )                           [defined] base'  ?\ variable base'                              base @ decimal                                                  [defined] binary  ?\ : binary  ( -- )  2 base !  ;              base !                                                          [defined] (d.)                                                  ?\ : (d.)  ( d n -- ca len )  <# 0 do  #  loop  #>  ;           : <bin  ( -- )  base @ base' ! binary ; \ switch to binary      : bin>  ( -- )  base' @ base !        ; \ and back              : (dbin.)  ( d n -- )  bin{ (d.) }bin type space  ;             : dbin.    ( d -- )  32 (dbin.)  ;                              : bin.     ( n -- )  s>d 16 (dbin.)  ;                          : binb.    ( b -- )  s>d 8 (dbin.)  ;                                                                                                                                                                                                                           ( ascii-type )                                                  : ascii-type  ( ca len -- )                                       dup if                                                            bounds do                                                         i c@ 127 and dup bl < if  drop [char] .  then  emit           loop                                                          else  2drop  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( dump )                                                        need break-key?  need hex.  need ascii-type                     [defined] bs ?\ : bs  ( -- )  8 emit  ;                         : dump  ( a len -- )                                              7 + -8 and 8 / 0                                                2dup <> if                                                        do                                                                cr dup hex.                                                     8 0 do  i over + @ flip hex.  2 +loop                           dup bs 8 ascii-type                                             break-key? if  exhaust  then                                  8 + loop                                                      else  2drop  then  drop  ;                                                                                                                                                                                                                                    ( decode )                                                      forth definitions decimal                                       variable decode-level  decode-level off \ depth of nesting      variable decode-address  \ in the word being decoded            : indent  ( -- )                                                  cr decode-address @ u. decode-level @ 2 * spaces  ;           : indent+  ( -- )  1 decode-level +! indent  ;                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( decode )                                                      : decode-compile    ( a1 -- a2 )  2+ dup @ 2+ pfa>nfa id.  ;    : decode-literal    ( a1 -- a2 )  2+ dup @ .  ;                 : decode-cliteral   ( a1 -- a2 )  2+ dup c@ . 1-  ;             : decode-branch     ( a1 -- a2 )  2+ dup @ u.  ;                : decode-dot-quote  ( a1 -- a2 )                                  2+ dup count type  dup c@ + 1 -  ;                            -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( decode )                                                      need case                                                       : decode-special  ( a1 -- a1 | a2 )                               dup @                                                           case                                                              ['] compile   of  decode-compile    endof                       ['] lit       of  decode-literal    endof                       ['] clit      of  decode-cliteral   endof                       ['] branch    of  decode-branch     endof                       ['] 0branch   of  decode-branch     endof                       ['] ?branch   of  decode-branch     endof                       ['] (loop)    of  decode-branch     endof                       ['] (+loop)   of  decode-branch     endof                       ['] (.")      of  decode-dot-quote  endof                     endcase  ;  -->                                                                                                               ( decode )                                                      : decode-end?  ( cfa -- f )                                       dup  ['] ;s =  swap ['] (;code) =  or  ;                      : colon-pfa?  ( pfa -- f )                                        pfa>cfa @ ['] : @ =  ;                                        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( decode )                                                      : (decode)  ( pfa --- )                                           dup colon-pfa? if                                                 dup pfa>cfa decode-address ! indent  ." : " dup pfa>nfa id.     begin   ( pfa+n ) dup decode-address !                                  dup @ dup ( pfa+n cfa cfa ) decode-end? 0=              while  \ high level & not end of colon definition                 ( pfa+n cfa ) 2+ ( pfa+n pfa' ) dup indent+  pfa>nfa id.        key case  [char] q  of  sp0 @ sp! quit  endof \ q                               bl  of  drop            endof \ space                                      swap recurse \ default                   endcase  decode-special                                     2+  -1 decode-level +!                                        repeat  indent 2+ pfa>nfa id. \ show the last word            else  ." Not a colon definition."  then  drop  ;  -->                                                                         ( decode )                                                      : decode-usage  ( -- )                                            cr ." Keys: space=more, q=quit, other=deeper." cr  ;          : decode  ( "name" -- )                                           decode-usage                                                    defined if  cfa>pfa  0 decode-level !  (decode)                         else  drop  5 error  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( list )                                                        need break-key?                                                 : list  ( n -- )                                                  dup scr !                                                       cr ." Scr # " .                                                 l/scr 0 do                                                        cr i 2 .r space i scr @ .line                                   break-key? ?exhaust                                           loop cr  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( break-key? )                                                  code break-key?  ( -- f )                                         CD c, 1F54 ,              \ call rom_break_key                  D2 c, ' true cfa>pfa ,    \ jp nc,true                          C3 c, ' false cfa>pfa ,   \ jp false                            end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( index .index )                                                need break-key?                                                 : .index  ( n -- )  cr dup 3 .r space 0 swap .line  ;           : index  ( n1 n2 -- )                                             1+ swap do                                                        cr i 3 .r space 0 i .line                                       break-key? if  exhaust  then                                  loop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( index-like )                                                  need break-key?  need .index                                    [defined] contains                                                ?\ : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;  : index-like  ( n1 n2 "name" -- )                                 parse-name 2swap                                                1+ swap do                                                        0 i (line) 2over contains if  i .index  then                    break-key? if  exhaust  then                                  loop  2drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                ( index-ilike )                                                 need break-key?  need .index                                    [defined] contains                                                ?\ : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;  : index-ilike  ( n1 n2 "name" -- )                                parse-name save-string 2dup uppers                              2swap 1+ swap do                                                  save-string  0 i (line) save-string 2dup uppers                 2over contains if  i .index  then                               break-key? if  exhaust  then                                  loop  2drop  ;                                                                                                                                                                                                                                                                                                                                                                                ( words )                                                       need break-key?                                                 [defined] tab ?\  : tab  ( -- )  6 emit  ;                      : words  ( -- )                                                   trail                                                           begin  dup 0<> break-key? 0= and  while                           dup id. tab  nfa>lfa @n                                       repeat drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( words-like )                                                  need break-key?                                                 [defined] contains                                                ?\ : contains  ( ca1 len1 ca2 len2 -- f )  search nip nip  ;  [defined] tab                                                     ?\  : tab  ( -- )  6 emit  ;                                  : words-like  ( "name" -- )                                       parse-name 2dup uppers trail  ( ca len nfa )                    begin  dup 0<> break-key? 0= and  while                           dup >r                                                          nfa>string 2over contains if  r@ id. tab  then                  r> nfa>lfa @n                                                 repeat drop 2drop  ;                                                                                                                                                                                                                                          ( where )                                                         ; XXX FIXME -- terminal input errors are not managed;           ; the screen of the last error is shown insted                : where  ( -- )                                                   error-pos 2@  ( n1 n2 )                                         dup if                                                            dup b/scr / dup scr !                                           ." Scr # " decimal . cr                                         swap c/l /mod c/l * rot block + c/l type cr                     here c@ - spaces [char] ^ emit                                else  2drop  then  ;                                                                                                                                                                                                                                                                                                                                                                          ( .s u.s )                                                      : .depth  ( n -- )                                                s>d <# [char] > hold #s [char] < hold #> type space  ;        : .s   ( -- )                                                     depth dup .depth                                                if  sp@ 2- s0 @ 2- do i @ . -2 +loop  then  ;                 : u.s   ( -- )                                                    depth dup .depth                                                if  sp@ 2- s0 @ 2- do i @ u. -2 +loop  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( marker ) \ 2nd approach                                       : get-every-latest  ( -- nfa0..nfan | nfa )                       voc-link @ begin                                                  dup cell - @  ( a nfa ) swap @                                dup 0= until  drop  ;                                         : set-every-latest  ( nfa0..nfan | nfa -- )                       voc-link @ begin                                                  dup cell - @  ( a nfa ) swap @                                dup 0= until  drop  ;                                         : marker@  ( -- x1..xn1 n1 nfa1..nfan2 n2 )                       depth >r                                                        here np@ voc-link @                                             depth r> - get-every-latest  ;                                : marker!  ( a -- )                                               set-order 0 do  2@ !  loop  ;                                                                                                 ( marker )                                                      : n,  ( x1..xn n -- )  0 do  ,  loop  ;                         : marker  ( "name" -- )                                           marker@ create n,  does>  ( -- ) ( pfa )  marker!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( marker )                                                      : get-every-latest  ( -- nfa0..nfan | nfa )                       voc-link @ begin                                                  dup cell - @  ( a nfa ) swap @                                dup 0= until  drop  ;                                         : set-every-latest  ( nfa0..nfan | nfa -- )                       voc-link @ begin                                                  dup cell - @  ( a nfa ) swap @                                dup 0= until  drop  ;                                         : marker@  ( -- x1..xn1 n1 nfa1..nfan2 n2 )                       depth >r  here np@ voc-link @                                   depth r> - get-every-latest  ;                                : marker!  ( a -- )                                               dup @ dup voc-link !  cell+ dup @ np!  cell+ @ dp !  ;                                                                                                                                        ( marker )                                                      : n,  ( x1..xn n -- )  0 do  ,  loop  ;                         : marker  ( "name" -- )                                           marker@ create n,  does>  ( -- ) ( pfa )  marker!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( assert( )                                                     variable assert-level ( -- a )                                  1 assert-level !                                                : assertn ( n -- )  assert-level @ > if  postpone (  then  ;    : assert0( ( -- )  0 assertn  ; immediate                       : assert1( ( -- )  1 assertn  ; immediate                       : assert2( ( -- )  2 assertn  ; immediate                       : assert3( ( -- )  3 assertn  ; immediate                       : assert( ( -- )  postpone assert1( ; immediate                 : (endassert) ( f -- )  0= 16 ?error ;                          : ) ( -- )  postpone (endassert) ; immediate                                                                                                                                                                                                                                                                                                                                                    ( source )  \ ==misc==                                          : source  ( -- ca len )  \ ANS Forth                              blk @ ?dup if  block b/buf  else  tib #tib @  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( call )                                                        code call  ( a -- )                                               E1 c,               \ pop hl                                    C5 c,               \ push bc                                   CD c, >mark         \ call call_hl                              C1 c,               \ pop bc                                    DD c, 21 c, next ,  \ ld ix,next                                jpnext              \ jp next                                   >resolve            \ call_hl:                                  E9 c,               \ jp (hl)                                   end-code                                                                                                                                                                                                                                                                                                                                                                                      ( xaccept )  \ ==keyboard==                                     : xaccept ( ca len -- len )                                       over + over ( bot eot cur )                                     begin xkey dup 13 <> \ not carriage return?                     while                                                             dup 12 =  \ delete?                                             if    drop  >r over r@ < dup  \ any chars?                            if  8 dup emit  bl emit  emit  then  r> +                 else  \ printable                                                     >r  2dup <>  \ more?                                            if r@ over c!  char+  r@ emit                                   then r> drop                                              then                                                          repeat  drop nip swap -  ;                                                                                                                                                                    ( inkey )                                                       need z80-asm                                                    code inkey  ( -- c | 0 )                                          bc push                                                         028E call \ KEY-SCAN ROM routine                                z if  \ is key press valid?                                       031E call \ KEY-TEST ROM routine                                cy if  \ is key code valid?                                       00 c ld#  \ XXX Spectrum Forth-83 does this                     d dec  a e ld                                                   0333 call \ KEY-DECODE ROM routine                            then                                                          then                                                            FF cp#  z if  a xor  then  \ convert FF to 00                   bc pop  pusha jp  end-code                                                                                                    ( inkey )                                                       need z80-asm                                                    code inkey  ( -- c | 0 )                                          di                                                              a xor                                                           01 iy 5 bitx  \ a new key pressed?                              nz if                                                             5C08 hl ldp#  \ LAST-K system variable                          m a ld                                                          01 iy 5 resx                                                  then                                                            ei                                                              pusha jp                                                        end-code                                                                                                                                                                                      ( key?? )                                                       need z80-asm                                                    code key??  ( -- f )                                              bc push                                                         028E call  \ ROM KEY_SCAN                                       here jrnz  >relmark 0 unresolved ! \ to return_false            031E call  \ ROM KEY_TEST                                       here jrnc  >relmark 1 unresolved ! \ to return_false            bc pop  ' true cfa>pfa jp                                       0 unresolved @ >relresolve                                      1 unresolved @ >relresolve                                      bc pop  ' false cfa>pfa jp                                      end-code                                                                                                                                                                                                                                                      ( key?? )                                                       need z80-asm                                                    code key??  ( -- f )                                              bc push                                                         028E call  \ ROM KEY_SCAN                                       0000 jpnz  |mark 0 unresolved ! \ to return_false               031E call  \ ROM KEY_TEST                                       0000 jpnc  |mark 1 unresolved ! \ to return_false               bc pop  ' true cfa>pfa jp                                       0 unresolved @ >resolve                                         1 unresolved @ >resolve                                         bc pop  ' false cfa>pfa jp                                      end-code                                                                                                                                                                                                                                                      ( @p )  \ ==hardware==                                          code @p  ( ca -- c )                                              E1 c,           \ pop hl                                        C5 c,           \ push bc                                       48 05 + c,      \ ld c,l                                        40 04 + c,      \ ld b,h                                        ED c, 68 c,     \ in l,(c)                                      C1 c,           \ pop bc                                        26 c, 00 c,     \ ld h,0x00                                     C3 c, pushhl ,  \ jp pushhl                                     end-code                                                                                                                                                                                                                                                                                                                                                                                      ( !p )                                                          code !p  ( c ca -- )                                              E1 c,           \ pop hl                                        D1 c,           \ pop de ; char in e                            C5 c,           \ push bc                                       48 05 + c,      \ ld c,l                                        40 04 + c,      \ ld b,h                                        ED c, 59 c,     \ out (c),e                                     C1 c,           \ pop bc                                        jpnext          \ jp (ix)                                       end-code                                                                                                                                                                                                                                                                                                                                                                                      ( extend size system turnkey )  \ ==turnkey==                   : extend  ( -- )                                                  latest 6 +origin !  \ top most word in `forth` vocabulary       here 22 +origin !  \ `fence` init value \ XXX OLD obsolete      here 24 +origin !   \ `dp` init value                           [ ' forth cfa>pfa 8 + ] literal 26 +origin !  ;               : size  ( -- u )  here 0 +origin -  ;                           : system  ( -- a len )  extend  0 +origin size 10 +  ;          : turnkey  ( cfa -- a len )  boot ! system  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( du.r u.r du. )  \ ==doublenumbers==                           : du.r  ( d n -- )  >r <# #s #> r> over - 0 max spaces type  ;  \ : u.r  ( n1 n2 -- )  >r 0 r> du.r  ;                          : du.  ( d -- )  0 du.r space  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( d- )                                                          need z80-asm                                                    code d-  ( d1|ud1 d2|ud2 -- d3|ud3 )                              de pop          \ DE=d2hi                                       exx                                                             de pop          \ DE'=d2lo                                      exx                                                             hl pop          \ HL=d1hi,DE=d2hi                               exx                                                             hl pop          \ HL'=d1lo                                      de subp                                                         hl push         \ 2OS=d1lo-d2lo                                 exx                                                             de sbcp         \ HL=d1hi-d2hi-cy                               pushhl jp                                                       end-code                                                      ( >number )  ==numberconversion==                               need /string                                                    : >number  ( d1 ca1 len1 -- d2 ca2 len2 )                         begin   dup                                                     while   over c@ base @ digit                                    while   >r 2swap r> swap base @ um* drop rot base @                     um* d+ 2swap 1 /string 1 dpl +!                         repeat then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( number? )                                                     : number?  ( ca len -- d true | false )                           over c@ [char] - = over 0> and dup >r 1                         and /string over c@ [char] . > and 0 0                          2swap ?dup                                                      if                                                                >number dpl on dup                                              if  1- over c@ [char] . - or  dpl off  then                     while                                                           then r> 2drop 2drop false                                       else drop r> if  dnegate  then true                           then  ;                                                                                                                                                                                                                                                                                                                       ( b# d# h# )                                                    : x# ( -- ) ( "ccc" -- n | d )                                    does> c@              \  new radix                              base @ >r  base !     \ save and set radix                      parse-name            \ get string                              ['] evaluate catch    \ convert to number, set trap             r> base !  throw  ;   \ restore radix before error control    create b# ( "name" -- n | d )  2 c, x# immediate                create d# ( "name" -- n | d ) 10 c, x# immediate                create h# ( "name" -- n | d ) 16 c, x# immediate                                                                                                                                                                                                                                                                                                                                                                                                                ( c# )                                                          : c#  ( "name" -- c )                                             parse-name drop c@ postpone literal  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( .b .d .h )                                                    : base.  ( -- )  does> c@ base @ >r base ! u. r> base !  ;      create bin.  ( n -- )   2 c, base.                              create dec.  ( n -- )  10 c, base.                              create hex.  ( n -- )  16 c, base.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( c>hex )                                                       hex                                                             : c>hex  ( c -- n )                                               30 - dup 9 > if  7 -  then  ;                                 decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( '. ) \ character prefix                                       hex  width @ 1 width !                                          : '.  ( -- n )                                                    here 2 + c@ postpone literal  ; immediate                     width ! decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( $.. $.... ) \ hex prefixes                                    need c>hex                                                      hex width @  1 width !                                          : $..  ( -- n )                                                   here 2 + c@ c>hex 10 * here 3 + c@ c>hex +                      postpone literal  ; immediate                                 : $....  ( -- n )                                                 0 here 6 + here 2 + do 10 * i c@ c>hex + loop                   postpone literal  ; immediate                                 width ! decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( 0x.. 0x.... )  \ hex prefixes                                 need c>hex                                                      hex  width @ 2 width !                                          : 0x..  ( -- n )                                                  here 3 + c@ c>hex 10 * here 4 + c@ c>hex +                      postpone literal  ; immediate                                 : 0x....  ( -- n )                                                0 here 7 + here 3 + do 10 * i c@ c>hex + loop                   postpone literal  ; immediate                                 width ! decimal                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( #... #..... ) \ hex prefixes                                  need c>hex                                                      width @  1 width !                                              : #...  ( -- n )                                                  here 2 + c@ c>hex 10 * here 3 + c@ c>hex +                      postpone literal  ; immediate                                 : #.....  ( -- n )                                                0 here 6 + here 2 + do 10 * i c@ c>hex + loop                   postpone literal  ; immediate                                 width !                                                                                                                                                                                                                                                                                                                                                                                                                                                         ( unless )                                                      : unless  ( f -- )  postpone ?branch >mark 2  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( don't )  \ ==controlstructures==                              : don't  ( n1 n2 -- | n1 n2 )                                     2dup = if  2drop unnest unnest  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( >l >l )                                                       code >l  ( x -- ) ( L: -- x )                                     de pop                                                          lp hl fthl                                                      e m ld  hl incp  d m ld  hl incp                                hl lp sthl                                                      jpnext                                                          end-code                                                      code l>  ( -- x ) ( L: x -- )                                     lp hl fthl                                                      hl decp  m d ld  hl decp  m e ld                                hl lp sthl                                                      pushhl jp                                                       next                                                                                                                                                                                          ( ?do )                                                         : (do)  ( n1 n2 -- )  2>r  ;                                    : (?do) 2dup = if 2drop r> drop then  ;                         : (loop)  ;                                                     Â  ( increments index -2nd item- on return stack)             Â  ( calculates flag for until )                              : (+loop)  ;                                                    : do      postpone (do) postpone begin                            ; immediate                                                   : ?do     postpone (?do) postpone (do) postpone begin             ; immediate                                                   : loop    postpone (loop) postpone until postpone unloop          ; immediate                                                   : +loop   postpone (+loop) postpone until postpone unloop         ; immediate                                                                                                                   ( ?do )                                                         : do ( -- flag addr)                                            Â  Â  postpone (do) 0 Â postpone begin ; Â immediate    : ?do ( -- addr1 flag addr2)                                    Â  Â  postpone (?do) postpone begin                         Â  Â  postpone (do) 1 Â postpone begin ; Â immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( ?do )                                                         variable ?do?                                                   : exchange ( x1 addr -- x2 ) dup @ rot rot !  ;                 : 2dup<> ( x1 x2 -- x1 x2 flag ) 2dup = 0=  ;                   : do                                                              postpone 2>r 0 ?do? exchange here                               ; immediate                                                   : ?do                                                             postpone 2dup<> postpone if postpone do ?do? on                 ; immediate                                                   : loop                                                            postpone (loop) , ?do? exchange if postpone then then           ; immediate                                                   : +loop                                                           postpone (+loop) , ?do? exchange if postpone then then          ; immediate                                                   ( ?do )                                                         variable ?do?                                                   : 2dup= ( x1 x2 -- x1 x2 flag ) 2dup =  ;                       : do                                                              ?do? @ ?do? off [compile] (do) here 0 ,  ; immediate          : ?do                                                             postpone 2dup= postpone if postpone do ?do? on                  ; immediate                                                   : complete-?do ( x dest | x -- )                                  ?do? @ if postpone then then ?do? !  ;                        : loop postpone (loop) , complete-?do  ; immediate              : +loop postpone (+loop) , complete-?do  ; immediate                                                                                                                                                                                                                                                                            ( j )                                                           code j                                                            2A c, rp ,      \ ld hl,(return_stack_pointer)                  11 c, 2 cells , \ ld de,2*cell                                  19 c,           \ add hl,de                                     C3 c, fetchhl , \ jp fetchhl                                    end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( k )                                                           code k                                                            2A c, rp ,      \ ld hl,(return_stack_pointer)                  11 c, 4 cells , \ ld de,4*cell                                  19 c,           \ add hl,de                                     C3 c, fetchhl , \ jp fetchhl                                    end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( i' )                                                          code i'  ( -- x )                                                        ( R: loop-sys -- loop-sys )                              2A c, rp ,        \ ld hl,(return_stack_pointer)                23 c,             \ inc hl                                      23 c,             \ inc hl                                      C3 c, fetchhl ,   \ jp fetchhl                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( j' )                                                          code j'  ( -- x )                                                        ( R: loop-sys1 loop-sys2 -- loop-sys1 loop-sys2 )        2A c, rp ,      \ ld hl,(return_stack_pointer)                  11 c, 3 cells , \ ld de,3*cell                                  19 c,           \ add hl,de                                     C3 c, fetchhl , \ jp fetchhl                                    end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( for step )                                                    code (step)  ( R: n -- n' )                                       2A c, rp ,                                                      5E c, 23 c, 56 c,                                               7A c, B3 c,                                                     1B c, 72 c, 2B c, 73 c,                                         C2 c, ' branch cfa>pfa ,                                        23 c, 23 c, 22 c, rp ,                                          03 c, 03 c, jpnext                                              end-code                                                      : for  ( n -- )  postpone >r <mark  ; immediate                 : step  ( -- )  postpone (step) <resolve  ; immediate                                                                                                                                                                                                                                                                           ( case )  \ ANS Forth version                                   0 constant case immediate  \ init count of ofs                  : of                                                              1+ >r                                                           postpone over  postpone =   \ copy and test case value          postpone if                 \ add orig to control flow stack    postpone drop               \ discards case value if =          r>  ; immediate                                               : endof                                                           >r  postpone else  r>  ; immediate                            : endcase                                                         postpone drop  \ discard case value                             0 do  postpone then  loop  ; immediate                                                                                                                                                                                                                        ( case )  \ fig-Forth version with compiler security            : case                                                            ?comp csp @ !csp 4  ; immediate                               : of                                                              4 ?pairs                                                        postpone over  postpone =  postpone 0branch >mark               postpone drop 5  ; immediate                                  : endof                                                           5 ?pairs  postpone branch >mark                                           swap 2  postpone then  4  ; immediate               : endcase                                                         4 ?pairs                                                        postpone drop                                                   begin  sp@ csp @ <>  while  2 postpone then  repeat             csp !  ;  immediate                                                                                                           ( case )  \ fig-Forth version without compiler security         : case                                                            csp @ !csp  ; immediate                                       : of                                                              postpone over  postpone =  postpone if  postpone drop           ; immediate                                                   : endof                                                           postpone else  ; immediate                                    : endcase                                                         postpone drop                                                   begin  sp@ csp @ <>  while  postpone then  repeat               csp !  ;  immediate                                                                                                                                                                                                                                                                                                           ( ?dov dov loopv +loopv )                                       : dov  compile (do) csp @ !csp here 3  ;                        : ?dov                                                            compile 2dup  compile (do)  compile <>                          postpone if                                                     2drop here swap 1 6  ; immediate                              : (resolve)                                                       begin  sp@ csp @ -  while  2 postpone then  repeat  csp !  ;  : loopv                                                           postpone loop (resolve)  ;                                    : +loopv                                                          postpone +loop (resolve)  ;                                                                                                                                                                                                                                                                                                   ( case: )                                                       : case:  ( -- )                                                   create  ]                                                       does>   ( n -- )                                                        ( n pfa ) swap cells + perform  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( test-case: )                                                  need case:                                                      : zx0 ." zero"  ;                                               : zx1 ." one"  ;                                                : zx2 ." two"  ;                                                case: zx  ( n -- )  zx0 zx1 zx2  ;                              3 associative: unzx  ( value -- n )  ' zx0 , ' zx1 , ' zx2 ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( associative: )  \ ==datastructures==                          need -rot                                                       : associative:  ( n -- )                                          constant                                                        does>  ( x -- index )                                             ( x pfa )                                                       dup @ ( x pfa n ) -rot dup @ 0 ( n x pfa n 0 )                  do ( n x pfa )                                                    cell+ 2dup @ = ( n x pfa' flag )                                if  2drop drop i unloop exit  then                            loop 2drop ( n )  ;                                                                                                                                                                                                                                                                                                                                                                         ( value )                                                       : value  ( n "name"  -- )  constant  ;                          : to  ( Interpretation: n "name" -- )                                 ( Compilation: "name" -- )                                  ' cfa>pfa comp? if    postpone literal postpone !                               else  !  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( value )                                                       variable to-message                                             : from  ( -- )  to-message off  ;  from                         : to    ( -- )  to-message on  ;                                : value  ( n "name" -- )                                          create ,  does>  to-message @ if  !  else  @  then  from  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ( value )                                                       variable (value)                                                : from  ( -- )  ['] @ (value) !  ;  from                        : to    ( -- )  ['] ! (value) !  ;                              : value  ( n "name" -- )                                          create ,  does>   (value) @ execute  from  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ( value )                                                       defer (value)                                                   : from  ( -- )  ['] @ ['] (value) defer!  ;  from               : to    ( -- )  ['] ! ['] (value) defer!  ;                     : value  ( n "name" -- )                                          create ,  does>  (value) from  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( set )                                                         : set  ( x a "name" -- )                                          create  swap , ,                                                does>   ( pfa )  dup @ swap cell+ @ !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( c@+ )                                                         need z80-asm                                                    code  c@+  ( ca - ca+1 c )                                        de pop                                                          de ftap                                                         de incp                                                         0 h ld#                                                         a l ld                                                          pushhlde jp                                                     end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( jiffy! jiffy@ -jiffy )                                        need !dosvar  need @dosvar                                      : jiffy!  ( a -- )  16 !dosvar  ;                               : jiffy@  ( -- a )  16 @dosvar  ;                               : -jiffy  ( -- )  8335 jiffy!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( ms )  \ ==time==                                              [defined] sys-frames ?\ 23672 constant sys-frames               : ms  ( n -- )                                                    20 / sys-frames @ +                                             begin  dup sys-frames @ u<  until drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( frames@ frames! frames0 )                                     [defined] sys-frames ?\ 23672 constant sys-frames               : frames@  ( -- d )                                               sys-frames @ [ sys-frames 2+ ] literal c@  ;                  : frames!  ( d -- )                                               [ sys-frames 2+ ] literal c! sys-frames !  ;                  : frames0  ( -- )  0. frames!  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( pause )                                                       need z80-asm  need call-cfa  need execute-hl                    code pause ( u --- )                                              de pop  bc push                                                 begin                                                             de push                                                         ' (wait) call-cfa  hl pop  execute-hl                           de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need call-cfa                                     defer (wait)  ' noop ' (wait) defer!                            code pause ( u --- )                                              de pop  bc push                                                 begin                                                             de push                                                         ' (wait) call-cfa                                               de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need execute-hl                                   code pause ( u --- )                                              de pop  bc push                                                 begin                                                             de push                                                         (wait) fthl  execute-hl                                         de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm  need execute-hl                                   variable (wait)  ' noop (wait) !                                code pause ( u --- )                                              de pop  bc push                                                 begin                                                             de push                                                         ' (wait) cfa>pfa fthl  execute-hl                               de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                      ( pause )                                                       need z80-asm                                                    variable (wait)  ' noop (wait) !                                code pause ( u --- )                                              de pop  bc push                                                 begin                                                             de push                                                         ' (wait) cfa>pfa fthl                                           here 6 + bc ldp# \ point IP to phony_compiled_word              next2 jp  \ execute the cfa in `(wait)`                         here cell+ ,  \ point to the phony cfa following                here cell+ ,  \ phony cfa, point to the code following          de pop  halt  de decp  de tstp  \ finished?                   z until                                                         bc pop  jpnext                                                  end-code                                                      ( just-pause )                                                  need z80-asm                                                    code just-pause ( u --- )                                         de pop  bc push                                                 begin                                                             halt  de decp  de tstp  \ finished?                           z until                                                         bc pop  jpnext                                                  end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( .context .current order vocs )  \ ==vocabularies==            : .context  ( -- )  context #vocs 0 do                                                dup @ ?dup if  pfa>nfa id.  then  cell+                       loop drop  ;                                : .current  ( -- )  current @ pfa>nfa id.  ;                    : order  ( -- )                                                   cr ." context: " .context cr ." current: " .current  ;        : vocs  ( -- )                                                    voc-link @                                                      begin  dup cell - pfa>nfa id.  @ dup 0= until  drop  ;                                                                                                                                                                                                                                                                                                                                                                                                        ( get-order set-order )                                         : (get-order)  ( n -- widn..wid1 n)                               1- -1 swap do  context i cells + @  -1 +loop  ;               : get-order  ( -- 0 | widn..wid1 n)                               #vocs ?dup if  (get-order)  then  #vocs  ;                    : (set-order)  ( widn..wid1 n -- )                                0 do  context i cells + !  loop  ;                            : set-order  ( -1 | 0 | widn..wid1 n -- )                         dup -1 =  if  drop only exit  then  -order                      ?dup if  (set-order)  then  ;                                                                                                                                                                                                                                                                                                                                                                                                                                 ( wid-of )                                                      : wid-of  ( "name" -- wid )  ' cfa>pfa  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( search-wordlist )                                             : search-wordlist ( ca len wid -- 0 | xt 1 | xt -1 )              >r 2dup uppers r>                                               @ (find-name) dup ?exit  nip  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( seed rnd random randomize )  \ ==rng==                        [defined] seed ?\ 23670 constant seed  \ system variable        : rnd  ( -- n )  seed @ 31421 * 6927 + dup seed !  ;            : random  ( n -- 0..n-1 )  rnd um* nip  ;                       : randomize  ( n -- )  seed !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ( random-b )                                                    code random-b  ( -- b )                                           ED c, 5F c,     \ ld a,r                                        C3 c, pusha ,   \ jp pusha                                      end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( ace-rnd )                                                     [defined] seed        ?\ 23670 constant seed                    [defined] sys-frames  ?\ 23672 constant sys-frames              : seedon  ( -- n )                                                seed @ 75 um* d>s 75 0 d+ 2dup u< - - 1- dup seed !  ;        : rnd  ( n1 -- n2 )  seedon um* d>s swap drop  ;                : randomize  ( n -- )                                             ?dup 0=  if  sys-frames @  then  seed !  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( v.Forth pseudo random number generator )                      [defined] seed ?\ 23670 constant seed                             : vrnd  ( n1 -- n2 )                                              1+ 8195 23672 @ um* 1 0 d+                                      16383 u/ drop dup seed !                                        swap mod  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ( random-n )                                                    [defined] seed                                                  ?\ 23670 constant seed  \ system variable                       code random-n  ( -- x )                                           seed fthl  hl push                                              hl addp  hl addp  hl addp  hl addp  hl addp  hl addp            de pop  de addp  0029 de ldp#  de addp                          seed sthl                                                       pushhl jp                                                       end-code                                                                                                                                                                                                                                                                                                                                                                                                                                                      ( z88random )                                                   [defined] seed                                                  ?\ 23670 constant seed  \ system variable                       : z88random  ( u1 -- u2 )                                         20077 16838 seed @                                              ud* 12345 0 d+ over seed !                                      rot ud/mod 2drop  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           ( random-test random-b-test random-n-test )                     need set-pixel                                                  need random                                                     : random-test  ( n -- )                                           cls  0 do  256 random 193 random set-pixel  loop  ;           need random-b                                                   : random-b-test  ( n -- )                                         cls  0 do  random-b random-b 192 min set-pixel  loop  ;       need random-n                                                   : random-n-test  ( n -- )                                         cls                                                             0 do  random-n 255 and                                                random-n 255 and 192 umin set-pixel                       loop  ;                                                                                                                                                                                       ( defers action-of )  \ ==deferredwords==                       : defers  ( "name" -- )  ' defer@ ,  ; immediate                : action-of  ( Interpretation: "name" -- cfa )                               ( Compilation:    "name" -- )                                   ( Runtime:        -- cfa )                           ' comp? if    postpone literal postpone defer@                          else  defer@  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ( <is> [is] is  )                                               : <is>  ( cfa "name" -- )  ' defer!  ;                          : [is]  ( cfa "name" -- )                                         ' postpone literal postpone defer!  ; immediate               : is  ( cfa "name" -- )                                           comp? if  postpone [is]  else  <is>  then  ; immediate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ( z80-asm )                                                     \ Z80 assembler for Solo Forth                                  only forth definitions                                          : 8*   ( n1 -- n2 )  2* 2* 2*  ;                                : z80-asm  ( -- )  assembler  ;                                 also assembler definitions hex                                  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- registers )                                        0 constant b   1 constant c   2 constant d   3 constant e       4 constant h   5 constant l   6 constant m   7 constant a       0 constant bc  2 constant de  4 constant hl                     6 constant sp  6 constant af                                    DD constant ix-op  FD constant iy-op                            : ix  ( -- rphl )  ix-op c, hl  ;                               : iy  ( -- rphl )  iy-op c, hl  ;                               : ?page  ( n -- n )  dup 80 + FF swap u< 1E ?error  ;           -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- words for defining the z80 instructions)           : m1  ( 8b "name" -- )                                            create c, does>  ( -- )  ( pfa ) c@ c,  ;                     : m2  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ + c,  ;               : m3  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) c@ swap 8* + c,  ;       : m4  ( 8b "name" -- )                                            create c, does>  ( 8b -- )  ( 8b pfa ) c@ c, c,  ;            : m5  ( 8b "name" -- )                                            create c, does>  ( 16b -- )  ( 16b pfa ) c@ c, ,  ;           : m6  ( 8b "name" -- )                                            create c, does>  ( r -- )  ( r pfa ) CB c, c@ + c,  ;           -->                                                                                                                                                                                           ( z80-asm -- words for defining the z80 instructions)           : m7  ( 8b "name" -- )                                            create c, does>  ( r bit -- )                                     ( r bit pfa ) CB c, c@ swap 8* + + c,  ;                    : m8  ( 16b "name" -- )                                           create , does>  ( -- )  ( pfa ) @ ,  ;                        : m9  ( 8b "name" -- )                                            create c, does>  ( a -- )                                         ( a pfa )  c@ c, here 1+ - ?page c,  ;                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- words for defining the z80 instructions)           need -rot                                                       : ma  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) c@ c, drop c,  ;                          : mb  ( 8b "name" -- )                                            create c, does>  ( disp rphl -- )                                 ( disp rphl pfa ) CB c, c@ c, drop c,  ;                    : mc  ( 8b "name" -- )                                            create c, does>  ( disp rphl bit -- )                             ( disp rphl bit pfa )                                           CB c, c@ rot drop rot c, swap 8* + c,  ;                    -->                                                                                                                                                                                                                                                             ( z80-asm -- opcodes)                                           00 m1 nop 02 m3 stap 03 m3 incp 04 m3 inc 05 m3 dec 07 m1 rlca  08 m1 exaf 09 m3 addp 0A m3 ftap 0B m3 decp 0F m1 rrca 10 m9    djnz 17 m1 rla 18 m9 jr  1F m1 rra 20 m9 jrnz 22 m5 sthl 27 m1  daa 28 m9 jrz 2A m5 fthl 2F m1 cpl 30 m9 jrnc 32 m5 sta 37 m1   scf 38 m9 jrc 3A m5 fta 3F m1 ccf 76 m1 halt 80 m2 add 88 m2    adc 90 m2 sub 98 m2 sbc B8 m2 cp C1 m3 pop C2 m5 jpnz C3 m5 jp  C5 m3 push C6 m4 add# C7 m2 rst C9 m1 ret CA m5 jpz CD m5 call  CE m4 adc# D2 m5 jpnc D3 m4 out 41 m3 outbc D6 m4 sub# D9 m1    exx DA m5 jpc DB m4 in 40 m3 inbc 0DE m4 sbc# E2 m5 jppo E3 m1  exsp E6 m4 and# E9 m1 jphl EA m5 jppe EB m1 exde EE m4 xor# F2  m5 jpp F3 m1 di  F6 m4 or# F9 m1 ldsp FA m5 jpm FB m1 ei FE m4  cp# 00 m6 rlc 08 m6 rrc 10 m6 rl 18 m6 rr 20 m6 sla  28 m6 sra  38 m6 srl  40 m7 bit 80 m7 res C0 m7 set B0ED m8 ldir B8ED m8   lddr 44ED m8 neg 57ED m8 ldai 47ED m8 ldia 56ED m8 im1 5EED m8  im2 B1ED m8 cpir 6FED m8 rld -->                                ( z80-asm -- opcodes)                                           : 0outbc  ( -- )  ED c, 71 c,  ;                                : jpix  ( -- )  ix-op c, jphl  ;                                : ldp#  ( 16b rp -- )  8* 1+ c, ,  ;                            : ld#  ( 8b r -- )  8* 06 + c, c,  ;                            : ld  ( r1 r2 -- )  8* 40 + + c,  ;                             : sbcp  ( rp -- )  ED c, 8* 42 + c,  ;                          : adcp  ( rp1 rp2 -- )  ED c, 8* 4A + c,  ;                     : stp  ( a rp -- )  ED c, 8* 43 + c, ,  ;                       : ftp  ( a rp -- )  ED c, 8* 4B + c, ,  ;                       : clr  ( rp -- )  0 swap ldp#  ;                                : ldp  ( rp1 rp2 -- )  2dup ld 1+ swap 1+ swap ld  ;            CF m4 hook \ rst 8                                              D7 m1 prt  \ rst 0x16                                           -->                                                                                                                             ( z80-asm -- index register opcodes)                            need -rot                                                       [defined] 3dup                                                  ?\ : 3dup  ( x1 x2 x3 -- x1 x2 x3 x1 x2 x3 )  dup 2over rot  ;  86 ma addx 8E ma adcx 96 ma subx 9E ma sbcx A6 ma andx          AE ma xorx B6 ma orx  BE ma cpx  34 ma incx 35 ma decx          06 mb rlcx 0E mb rrcx 16 mb rlx  1E mb rrx  26 mb slax          2E mb srax 3E mb srlx 46 mc bitx 86 mc resx C6 mc setx          : ftx   ( disp rpi r -- )   nip 8* 46 + c, c,  ;                : stx   ( r disp rphl -- )  drop swap 70 + c, c,  ;             : st#x  ( 8b disp rpi -- )  drop 36 c, swap c, c,  ;            : ftpx  ( disp rpi rp -- )  3dup 1+ ftx rot 1+ -rot ftx  ;      : stpx  ( disp rpi rp -- )  3dup 1+ stx rot 1+ -rot stx  ;      -->                                                                                                                                                                                             ( z80-asm -- conditional ret and call)                          20 constant z  28 constant nz  30 constant cy  38 constant nc   C2 constant z'  CA constant nz' D2 constant cy' DA constant nc' E2 constant pe' EA constant po' F2 constant m'  FA constant p'  : ?ret  ( op -- )  8 xor 2- c,  ;                               : retc  ( -- )  cy' ?ret ;    : retnc  ( -- )  nc' ?ret  ;      : retz  ( -- )  z' ?ret ;     : retnz  ( -- )  nz' ?ret  ;      : retm  ( -- )  m' ?ret ;     : retp  ( -- )  p' ?ret  ;        : retpe  ( -- )  pe' ?ret ;   : retpo  ( -- )  po' ?ret  ;      : ?call  ( a op -- )  8 xor 2+ c, ,  ;                          : callc  ( -- )  cy' ?call ;    : callnc  ( -- )  nc' ?call  ;  : callz  ( -- )  z' ?call ;     : callnz  ( -- )  nz' ?call  ;  : callm  ( -- )  m' ?call ;     : callp  ( -- )  p' ?call  ;    : callpe  ( -- )  pe' ?call ;   : callpo ( -- )  po' ?call  ;   -->                                                                                                                             ( z80-asm -- control structures with relative jumps)            : >relmark  ( -- orig )  here 1-  ;                             : relresolve  ( orig dest -- )  1- over - ?page swap c!  ;      : >relresolve  ( orig -- )  here relresolve  ;                  : <relresolve  ( dest -- )  here 1- swap relresolve  ;          : if  ( op -- orig cs-id )  , >relmark 0A  ;                    : then  ( orig cs-id -- )  0A ?pairs >relresolve  ;             : else  ( orig cs-id -- cs-id ) \ XXX TODO document               0A ?pairs 18 if rot swap then 0A  ;                           : begin  (  -- dest cs-id )  <mark 0B  ;                        : while  (  op -- orig cs-id )  if 2+  ;                        : until  (  dest cs-id op -- )  , 0B ?pairs <relresolve  ;      : again  (  dest cs-id -- )  18 until  ;  \ compile `jr`        : step    ( dest cs-id -- )  10 until  ;  \ compile `djnz`      : repeat  (  dest cs-id1 orig cs-id2 )  2swap again 2- then  ;  -->                                                             ( z80-asm -- control structures with absolute jumps)            : if'  (  op -- orig cs-id )  c, >mark 08  ;                    : then'  (  orig cs-id -- )  08 ?pairs >resolve  ;              : else'  (  cs-id -- cs-id )                                      08 ?pairs C3 if' rot swap then' 08  ;                         : begin'  (  -- dest cs-id )  <mark 09  ;                       : while'  (  op -- orig cs-id )  if' 2+  ;                      : until'  (  cs-id op -- )  c, 09 ?pairs <resolve  ;            : again'  (  cs-id -- )  C3 until'  ;                           : repeat'  (  dest cs-id1 orig cs-id2 )                           2swap again' 2- then'  ;                                      : |mark  ( -- a )  here 2-  ;                                   : |resolve  ( a -- )  |mark swap !  ;                           -->                                                                                                                                                                                             ( z80-asm -- last opcodes and macros)                           A0 m2 and  B0 m2 or  A8 m2 xor                                  : subp  ( rp -- )  a and sbcp  ;                                : tstp  ( rp -- )  dup a ld 1+ or  ;                            -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( z80-asm -- unresolved macro endm )                            6 cells allocate-string                                         : unresolved  ( n -- a )  cells [ dup ] literal +  ;  drop      only forth definitions also assembler                           : macro  ( "name" -- )  asm postpone :  ;                       : endm  ( -- )  end-asm postpone ;  ;  immediate                need @c+  need for                                              : <<  ( -- a depth )  here depth  ;                             : >>  ( a depth -- )                                              depth 1- - 8 ?error cr base @ >r hex                            dup 4 u.r space  here over - for  c@+ 3 u.r  step drop          r> base !  space   ;                                          decimal only forth                                                                                                                                                                                                                                              ( execute-hl call-cfa )                                         macro execute-hl  ( -- )                                          here 6 + bc ldp# \ point IP to phony_compiled_word              next2 jp  \ execute the cfa in HL                               here cell+ ,  \ point to the phony cfa following                here cell+ ,  \ phony cfa, point to the code following          endm                                                          macro call-cfa  ( cfa -- )                                        hl ldp#  execute-hl                                             endm                                                                                                                                                                                                                                                                                                                                                                                                                                                          ( until-test )                                                  need z80-asm  need dump                                         code until-test  ( -- )                                           begin                                                             nop                                                           z until  jpnext                                                 end-code                                                      ' until-test cfa>pfa 5 dump                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ( if'-test )                                                    need z80-asm  need dump                                         code if'-test  ( -- )                                             .( here is ) here u.                                            p' if'  \ not expecting a regular character                       nz if  \ not expecting the column                                 cpl  C0 add#  \ now A = 191 - char                              hl incp                                                       then                                                            hl incp  a m ld                                                 ret                                                           then'  end-code                                               ' if'-test cfa>pfa dup here swap - dump                                                                                                                                                                                                                         ( a! a@ )  \ ==addressregister==                                variable a                                                      code a!  ( a -- )                                                 E1 c,                 \ pop hl                                  22 c, a ,             \ ld (a),hl                               jpnext                \ jp (ix)                                 end-code                                                      code a@  ( -- a )                                                 2A c, a ,             \ ld hl,(a)                               C3 c, pushhl ,        \ jp pushhl                               end-code                                                                                                                                                                                                                                                                                                                                                                                      ( !a @a )                                                       need a!                                                         code !a  ( u -- )                                                 D1 c,                          \ pop de                         2A c, a ,                      \ ld hl,(a)                      70 03 + c,  23 c,  70 04 + c,  \ ld (hl),e  inc hl  ld (hl),d   jpnext                         \ jp (ix)                        end-code                                                      code @a  ( -- u )                                                 2A c, a ,             \ ld hl,(a)                               5E c,                 \ ld e,(hl)                               23 c,                 \ inc hl                                  66 c,                 \ ld h,(hl)                               68 03 + c,            \ ld l,e                                  C3 c, pushhl ,        \ jp pushhl                               end-code                                                      ( c!a c@a )                                                     need a!                                                         code c!a  ( c -- )                                                D1 c,                 \ pop de                                  2A c, a ,             \ ld hl,(a)                               70 03 + c,            \ ld (hl),e                               jpnext                \ jp (ix)                                 end-code                                                      code c@a  ( -- c )                                                2A c, a ,             \ ld hl,(a)                               6E c,                 \ ld l,(hl)                               26 c, 00 c,           \ ld h,0                                  C3 c, pushhl ,        \ jp pushhl                               end-code                                                                                                                                                                                      ( !a+ @a+ )                                                     need a!                                                         code !a+  ( u -- )                                                D1 c,                 \ pop de                                  2A c, a ,             \ ld hl,(a)                               70 03 + c,  23 c,     \ ld (hl),e  inc hl                       70 04 + c,  23 c,     \ ld (hl),d  inc hl                       22 c, a ,  jpnext     \ ld (a),hl  jp (ix)                      end-code                                                      code @a+  ( -- u )      \ Fetch cell at `a` with increment.       2A c, a ,             \ ld hl,(a)                               5E c,  23 c,          \ ld e,(hl)  inc hl                       56 c,  23 c,          \ ld d,(hl)  inc hl                       22 c, a ,             \ ld (a),hl                               D5 c,  jpnext         \ push de  jp (ix)                        end-code                                                      ( c!a+ c@a+ )                                                   need a!                                                         code c!a+  ( c -- )                                               D1 c,                 \ pop de                                  2A c, a ,             \ ld hl,(a)                               70 03 + c,  23 c,     \ ld (hl),e  inc hl                       22 c, a ,  jpnext     \ ld (a),hl  jp (ix)                      end-code                                                      code c@a+  ( -- c )                                               2A c, a ,             \ ld hl,(a)                               5E c,  23 c,          \ ld e,(hl)  inc hl                       06 c, 00 c,           \ ld d,0                                  22 c, a ,             \ ld (a),hl                               D5 c,  jpnext         \ push de  jp (ix)                        end-code                                                                                                                      .( heap 0)                                                      also forth definitions                                          vocabulary heap-voc  heap-voc definitions                       : unique (  )  VARIABLE  ;                                      0 1 2 UM/MOD NIP 1- CONSTANT maxpos                             256 CELLS CONSTANT heapsize                                     4 CELLS 1- CONSTANT hysteresis                                  unique allocationerror                                          3 CELLS CONSTANT headsize                                       : adjustsize ( n -- n)  headsize +  hysteresis OR  1+  ;        0 adjustsize CONSTANT overhead                                  CREATE sentinel  HERE CELL+ ,  maxpos ,  0 ,  0 ,               CREATE heap  heapsize ALLOT                                     VARIABLE nextnode  -->                                                                                                                                                                          .( heap 1)                                                      : >size ( addr -- addr)  CELL+  ;                               : >prev ( addr -- addr)  2 CELLS +  ;                           : init-heap (  )  heap DUP nextnode !                             DUP DUP !                                                       DUP heapsize  OVER >size !                                      >prev !  ;                                                    init-heap                                                       : attach ( addr)                                                  >prev @  DUP sentinel ROT !  sentinel >prev !  ;              : search  ( addr size -- addr|0)                                  >R BEGIN 2@ SWAP R@ < INVERT UNTIL                              R> DROP  >prev @  ;                                           : detach ( addr)  DUP >prev @ !  ;                              -->                                                                                                                             .( heap 2)                                                      : findspace ( size -- addr|0)  nextnode @                                  DUP      attach                                                 DUP ROT  search                                                 SWAP     detach  ;                                   : fits ( size addr -- flag)  >size @ SWAP -  overhead  <  ;     : togglesize ( addr)  >size DUP @  NEGATE SWAP !  ;             : next! ( addr)  nextnode !  ;                                  : sizes! ( size addr -- addr)                                     2DUP + >R  >size 2DUP @ SWAP -                                  R@ >size !   SWAP NEGATE SWAP !  R>  ;                        : links! ( addr1 addr2)                                           2DUP SWAP @  2DUP  SWAP !  >prev !                              2DUP >prev !   SWAP !  ;                                      : newnode ( size addr)  TUCK sizes!  links!  ;                  -->                                                             .( heap 3)                                                      : makenode ( size addr)                                           2DUP fits IF  togglesize DROP  ELSE  newnode  THEN  ;         FORTH-WORDLIST SET-CURRENT                                      : ALLOCATE ( u -- addr ior)                                       DUP 0< IF  allocationerror                                           ELSE  adjustsize                                                DUP findspace                                                   DUP IF  DUP next!                                                 TUCK makenode                                                   headsize +  0                                                   ELSE  DROP allocationerror                                      THEN                                                          THEN  ;                                                  MEMORY-ALLOC-WORDLIST SET-CURRENT  -->                                                                                          .( heap 4)                                                      : mergesizes ( addr addr)                                         >size @ SWAP >size +!  ;                                      : mergelinks ( addr addr)                                         @ 2DUP SWAP !  >prev !  ;                                     : jiggle (  )                                                     nextnode @ @  >prev @  next!  ;                               : merge ( addr)                                                   DUP @ 2DUP mergesizes                                                mergelinks  jiggle  ;                                    : ?merge ( addr1 addr2)  >size @                                  0> IF                                                             DUP DUP @                                                       U< IF  DUP merge  THEN                                        THEN  DROP  ;  -->                                                                                                            .( heap 5)                                                      : ?mergenext ( addr)  DUP @ ?merge  ;                           : ?mergeprev ( addr)  >prev @ DUP ?merge  ;                     FORTH-WORDLIST SET-CURRENT                                      : FREE ( addr -- ior)                                             headsize -  DUP togglesize  DUP ?mergenext  ?mergeprev  0  ;  MEMORY-ALLOC-WORDLIST SET-CURRENT                               VARIABLE stash                                                  : savelink ( addr)  @ stash !  ;                                : restorelink ( addr)  stash @  SWAP !  ;                       : fixprev ( addr)  DUP >prev @ !  ;                             : fixnext ( addr)  DUP @ >prev !  ;                             : fixlinks ( addr)  DUP fixprev  DUP fixnext  @ fixnext  ;      -->                                                                                                                                                                                             .( heap 6)                                                      : fixsize ( addr)                                                 DUP >size @ 0>                                                  IF  DUP @  2DUP <                                                   IF    OVER - SWAP >size !  ELSE  2DROP  THEN                ELSE  DROP  THEN  ;                                           : fixsizes ( addr)  DUP fixsize  >prev @ fixsize  ;             : repair ( addr)                                                  DUP restorelink                                                 DUP fixlinks  DUP fixsizes                                      togglesize  ;                                                 : toobig? ( addr size -- flag)                                    SWAP  >size @  >  ;                                           -->                                                                                                                                                                                             .( heap 7)                                                      : copynode ( addr1 addr2)                                         OVER >size @  headsize -                                        ROT  headsize + ROT ROT MOVE  ;                               : enlarge ( addr1 size -- addr2 ior)                              OVER  ?mergeprev                                                ALLOCATE DUP >R                                                 IF  SWAP repair  ELSE  TUCK copynode  THEN  R>  ;             : adjust ( addr1 size1 -- addr2 size2)                            adjustsize >R                                                   headsize -                                                      DUP savelink                                                    DUP togglesize                                                  DUP ?mergenext R>  ;                                          -->                                                                                                                             .( heap 8)                                                      FORTH-WORDLIST SET-CURRENT                                      : RESIZE ( addr1 u -- addr2 ior)                                  DUP 0<  IF  DROP allocationerror                                        ELSE  adjust  2DUP toobig?                                            IF enlarge                                                      ELSE  OVER makenode headsize +  0  THEN                   THEN  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ( editor )                                                      only forth definitions                                          need list  need update  need flush                              need command                                                    vocabulary editor  also editor definitions  hex                 : text  ( "text<eol>" -- )                                        pad c/l 1+ blank  command  pad place  ;                       : line  ( n -- a )                                                dup FFF0 and 17 ?error scr @ (line) drop  ;                   : #locate  ( -- n1 n2 )  r# @ c/l /mod  ;                       : #lead  ( -- a n )  #locate line swap  ;                       : #lag  ( -- a n )  #lead dup >r + c/l r> -  ;                  : -move  ( a n -- )  line c/l cmove update  ;                   : h  ( n -- )  line pad 1+ c/l dup pad c! cmove  ;              -->                                                                                                                             ( editor )                                                      : e  ( n -- )  line c/l blank update  ;                         : s  ( n -- )  dup 1 - 0E do i line i 1+ -move -1 +loop e  ;    : d  ( n -- )  dup h 0F dup rot do i 1+ line i -move loop e  ;  : m  ( n -- )                                                     r# +! cr space #lead type [char] _ emit                         #lag type #locate . drop  ;                                   : t  ( n -- )  dup c/l * r# ! dup h 0 m  ;                      : l  ( n -- )  scr @ list 0 m  ;                                : r  ( n -- )  pad 1+ swap -move  ;                             : p  ( n "text<eol>"  -- )  text r  ;                           : i  ( n -- )  dup s r  ;                                       : top  ( -- )  0 r# !  ;                                        -->                                                                                                                                                                                             ( editor )                                                      : clear  ( n -- )                                                 scr !  10 0 do [ also forth ] i [ previous ] e loop  ;        : -text  ( a1 len1 a2 -- f )                                      swap ?dup if                                                      over + swap do                                                    dup c@ [ also forth ] i [ previous ] c@ -                       if  0= exhaust  else 1+  then                                 loop  else  drop 0=  then  ;                                -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( editor )                                                      also forth                                                      : match  ( a1 len1 a2 len2 -- tf n3 | ff n4 )                     >r >r 2dup r> r> 2swap over + swap                              do                                                                2dup i -text                                                    if  >r 2drop r> - i swap - 0 swap 0 0 exhaust  then           loop                                                            2drop swap 0= swap ;  previous                                : 1line  ( -- f )  #lag pad count match r# +!  ;                : find  ( -- )                                                    begin                                                             03FF r# @ <                                                     if  top pad here c/l 1+ cmove 0 error  then  1line            until  ;                                                      -->                                                             ( editor )                                                      : delete  ( n -- )                                                >r #lag + r@ - #lag r@ negate r# +! #lead + swap cmove          r> blank  ;                                                   : n  ( -- )  find 0 m  ;                                        : f  ( "text<eol>" -- )  text n  ;                              : b  ( -- )  pad c@ negate m  ;                                 : x  ( "text<eol>" -- )  text find pad c@ delete 0 m  ;         : till  ( "text<eol>" -- )                                        #lead + text 1line 0= 0 ?error #lead + swap - delete 0 m  ;   -->                                                                                                                                                                                                                                                                                                                                                                                             ( editor )                                                      : (c)  ( ca len -- )                                              #lag rot over min >r r@ r# +! r@ - >r                           dup here r@ cmove here #lead + r> cmove r> cmove 0 m            update  ;                                                     : c  ( "text<eol>" -- )                                           text pad count dup if  (c)  else  2drop  then  ;              also forth                                                      : copy  ( n1 n2 -- )                                              b/scr * swap b/scr * b/scr over + swap                          do                                                                dup i block 2- ! 1+ update                                    loop  drop flush  ;  previous                                 only forth definitions decimal                                                                                                                                                                  .( siderator )                                                  \ Siderator                                                     \ A game for the ZX Spectrum                                    \ Copyright (C) 2009,2010,2013,2015 Marcos Cruz                 \ (programandala.net)                                           only forth definitions                                          need rnd  need udg:  need inkey  need break-key?                [defined] binary  ?\ : binary  ( -- )  2 base !  ;              vocabulary siderator                                            also siderator definitions  decimal                             -->                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   variable x          variable speed                              variable parsecs    variable record  record off                 999 constant max-speed                                          char 5 constant left-key  char 8 constant right-key             8192 constant 'screen \ XXX OLD                                 : at  ( line col -- )  swap at-xy  ;                            : pause  ( -- )  begin  inkey  until  ;  -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ( siderator )                                                   15360 constant charset  \ ROM charset                           : char>a  ( c -- a )  8 * charset +  ;                          : udg>a  ( c -- a )  128 - 8 * udg +  ;                         : char>udg  ( c0 c1 -- )  swap char>a swap udg>a 8 cmove  ;     128 constant star0-udg  char * star0-udg char>udg               binary                                                          00011000                                                        00001000                                                        00011000                                                        00010000                                                        00011000                                                        00001000                                                        00011000                                                        00010000 decimal 129 udg: star1-udg  -->                                                                                        ( siderator )                                                   130 constant star2-udg                                          char | star2-udg char>udg                                       binary                                                          00001000                                                        00000000                                                        00001000                                                        00000000                                                        00001000                                                        00000000                                                        00001000                                                        00000000 decimal 131 udg: star3-udg  -->                                                                                                                                                                                                                                                                                        ( siderator )                                                   binary                                                          10000001                                                        10000001                                                        11000011                                                        11100111                                                        11111111                                                        01100110                                                        00111100                                                        00011000 decimal 132 udg: craft-udg  -->                                                                                                                                                                                                                                                                                                                                                                                                                        ( siderator )                                                   : pressed?  ( c -- f )  inkey =  ;                              : left  ( col -- col' )  left-key pressed? + 0 max  ;           : right  ( col -- col' )  right-key pressed? - 31 min  ;        : rudder  ( -- )  x @ right left x !  ;                         -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   need between                                                    4 constant #stars                                               : star-coords  ( -- y x )  23 31  ;                             : .star  ( c -- )                                                 star-coords 1+ random at 1 bright emit 0 bright  ;            : stars/speed  ( -- n )  speed @ #stars 1- max-speed */ 1+  ;   : scroll  ( -- )  star-coords at cr cr  ;                       : .stars  ( -- )                                                  stars/speed dup [ star0-udg 1- ] literal + swap 0               do  dup .star  loop  drop  ;                                  : star=  ( c -- f )  star0-udg star3-udg between  ;             : star<>  ( c -- f )  star= 0=  ;                               -->                                                                                                                                                                                             ( siderator )                                                   : craft-coords  ( -- y x )  10 x @  ;                           : craft-at  ( -- )  craft-coords at  ;                          : -craft  ( -- )  craft-at space  ;                             : .craft  ( -- )  craft-at craft-udg 5 ink emit 7 ink  ;        -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   : .datum  ( u -- ) 0 <# # # # #> type space  ;                  : delay  ( -- )  max-speed speed @ - 2 / 0  do  loop  ;         : .speed  ( -- )  ." Speed:" speed @ .datum  ;                  : +speed  ( u1 -- u2 )                                            dup 10 / 1 max  parsecs @ 4 mod 0= abs *  + max-speed min  ;  : faster  ( -- )  speed @ +speed speed !  ;                     : .parsecs  ( -- )  ." Parsecs:" parsecs @ .datum  ;            : farther  ( -- )  parsecs @ 1+ parsecs !  ;                    : .record  ( -- )  ." Record:" record @ .datum  ;               : .info  ( -- )  0 dup at .speed .parsecs .record  ;            -->                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   need j  need ocr                                                : blast-delay  ( -- )  32 0  do  loop  ;                        : (blast)  ( -- )                                                 .craft blast-delay craft-at star0-udg emit blast-delay  ;     : blast  ( -- )  256 0  do  (blast)  loop  ;                    : halt  ( -- )                                                    32 0  do  24 0 do                                                 i j ocr star= if  i j at-xy  star0-udg emit  then             loop  loop  ;                                                 -->                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   : safe?  ( -- f )  craft-coords swap ocr star<>  ;              : continue?  ( -- f )  safe? break-key? 0= and  ;               : new-record  ( -- )                                              parsecs @ record @ >  if  parsecs @ record !  then  ;         : game-over  ( -- )                                               blast halt  11 dup at ." GAME OVER"                             new-record .info 22 0 at  colors0  ;                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   \ Instructions                                                  : about  ( -- )                                                   cr ." Siderator 2: Jugdement Day"  cr                           cr ." Copyright (C) Marcos Cruz"                                cr ." (programandala.net)"                                      cr ." Version: 2015-09-02"  ;                                 : objective  ( -- )                                               cr ." Your objective is to travel as"                           cr ." much parsecs as possible"                                 cr ." while dodging the stars."                                 cr ." Anyway you're supposed to die"                            cr ." before the 1000th parsec"                                 cr ." because four digits would ruin"                           cr ." the score panel."  ;                                    -->                                                             ( siderator )                                                   \ Instructions                                                  : keys  ( -- )                                                    cr ." Rudder keys: "                                            left-key emit space right-key emit                              cr ." Autodestruction key: Break"  ;                          : instructions  ( -- )  objective cr keys  ;                    : wait  ( -- )  cr cr ." Press any key to start." pause  ;      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   need frames@                                                    : init-colors  ( -- )                                             0 paper 7 ink 0 flash 0 bright 0 inverse 0 border  ;          : init-screen  ( -- )                                             init-colors cls about cr instructions wait cls  ;             : 4+-  ( n1 -- n2 )  9 random 4 - +  ;                          : init  ( -- )                                                    frames@ s>d randomize  udg-ocr                                  init-screen  15 4+- x ! parsecs off  speed off  ;             -->                                                                                                                                                                                                                                                                                                                                                                                             ( siderator )                                                   : run ( -- )                                                      init                                                            begin   -craft scroll  faster farther .info  continue?          while   rudder .craft .stars  delay                             repeat  game-over  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          